<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teller Desk • 창구</title>

  <!-- Netlify Identity Widget -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    :root{
      --bg:#0b0f19; --panel:#0f1629; --panel2:#0c1222; --border2:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.64); --muted2:rgba(255,255,255,.45);
      --accent:#6ee7ff; --accent2:#9d7bff; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --shadow:0 12px 30px rgba(0,0,0,.45); --radius:16px; --radius2:12px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(110,231,255,.22), transparent 60%),
        radial-gradient(1000px 550px at 90% 0%, rgba(157,123,255,.18), transparent 55%),
        radial-gradient(900px 700px at 60% 110%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    a{color:inherit; text-decoration:none}
    button,input,select,textarea{font:inherit; color:inherit}
    ::selection{background: rgba(110,231,255,.25)}
    .app{height:100%; display:grid; grid-template-columns:280px 1fr;}
    .sidebar{
      border-right:1px solid var(--border2);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      padding:18px 14px 14px; display:flex; flex-direction:column; min-width:260px;
    }
    .brand{display:flex; align-items:center; gap:12px; padding:10px 10px 16px;}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg, rgba(110,231,255,.85), rgba(157,123,255,.85));}
    .brand h1{font-size:14px;margin:0;letter-spacing:.2px;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:2px}
    .nav{margin-top:6px;display:flex;flex-direction:column;gap:6px;padding:6px;border-radius:var(--radius);background:rgba(0,0,0,.12);border:1px solid var(--border2);}
    .nav button{width:100%;text-align:left;border:0;background:transparent;padding:10px 10px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:10px;color:var(--muted);transition:.15s ease;}
    .nav button:hover{background:rgba(255,255,255,.05);color:var(--text)}
    .nav button.active{background:rgba(110,231,255,.12);border:1px solid rgba(110,231,255,.22);color:var(--text)}
    .dot{width:10px;height:10px;border-radius:4px;background:rgba(255,255,255,.18)}
    .nav button.active .dot{background:linear-gradient(135deg, rgba(110,231,255,.95), rgba(157,123,255,.85));box-shadow:0 0 0 3px rgba(110,231,255,.10)}
    .sidebox{margin-top:12px;padding:12px;border-radius:var(--radius);border:1px solid var(--border2);background:rgba(0,0,0,.14);}
    .sidebox h3{margin:0 0 8px;font-size:12px;color:var(--muted)}
    .chiprow{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid var(--border2);background:rgba(255,255,255,.04);color:var(--muted)}
    .chip strong{color:var(--text);font-weight:650}
    .sidebar footer{margin-top:auto;padding:10px;color:var(--muted2);font-size:12px;line-height:1.4}
    .main{height:100%;display:flex;flex-direction:column;overflow:hidden}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 18px;border-bottom:1px solid var(--border2);background:rgba(0,0,0,.10);backdrop-filter:blur(8px);
    }
    .crumbs{display:flex;flex-direction:column;gap:2px}
    .crumbs .title{font-weight:750;letter-spacing:.2px}
    .crumbs .sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;align-items:center;gap:10px}
    .search{
      width:min(520px, 42vw);display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:14px;
      border:1px solid var(--border2);background:rgba(255,255,255,.04);
    }
    .search input{border:0;outline:0;background:transparent;width:100%;color:var(--text)}
    .kbd{font-family:var(--mono);font-size:11px;color:var(--muted);border:1px solid var(--border2);padding:3px 6px;border-radius:8px;background:rgba(0,0,0,.18)}
    .pill{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--border2);background:rgba(255,255,255,.04);cursor:pointer;user-select:none}
    .avatar{width:26px;height:26px;border-radius:10px;background:linear-gradient(135deg, rgba(52,211,153,.8), rgba(110,231,255,.8))}
    .pill small{display:block;color:var(--muted);font-size:11px;margin-top:1px}
    .content{overflow:auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    .card{border-radius:var(--radius);border:1px solid var(--border2);background:rgba(0,0,0,.18);box-shadow:var(--shadow);overflow:hidden}
    .card .head{padding:14px 14px 10px;border-bottom:1px solid var(--border2);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,.04), transparent)}
    .card .head h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .head p{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.45}
    .card .body{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input,.field select,.field textarea{width:100%;border-radius:12px;border:1px solid var(--border2);background:rgba(255,255,255,.04);padding:10px 10px;outline:0}
    .field textarea{min-height:86px;resize:vertical}
    .btnrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{border:1px solid var(--border2);background:rgba(255,255,255,.05);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s ease}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.primary{border:1px solid rgba(110,231,255,.30);background:rgba(110,231,255,.12)}
    .btn.primary:hover{background:rgba(110,231,255,.16)}
    .btn.danger{border:1px solid rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .btn.ghost{border:1px dashed var(--border2);background:transparent}
    .mini{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border2);text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:650}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border2);background:rgba(255,255,255,.04);color:var(--muted);font-size:11px;white-space:nowrap}
    .tag.ok{border-color:rgba(52,211,153,.28);background:rgba(52,211,153,.10);color:rgba(255,255,255,.85)}
    .tag.warn{border-color:rgba(251,191,36,.28);background:rgba(251,191,36,.10);color:rgba(255,255,255,.85)}
    .tag.bad{border-color:rgba(251,113,133,.30);background:rgba(251,113,133,.10);color:rgba(255,255,255,.85)}
    .split{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .stat{display:flex;flex-direction:column;gap:4px;padding:10px 12px;border-radius:14px;border:1px solid var(--border2);background:rgba(255,255,255,.04);min-width:180px}
    .stat b{font-size:14px}
    .stat span{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .view{display:none}
    .view.active{display:block}
    .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:50}
    .toast{width:min(380px, calc(100vw - 32px));border-radius:16px;border:1px solid var(--border2);background:rgba(15,22,41,.92);backdrop-filter:blur(10px);box-shadow:0 18px 40px rgba(0,0,0,.55);padding:12px;display:flex;gap:10px;align-items:flex-start}
    .toast .ticon{width:12px;height:12px;border-radius:5px;background:rgba(110,231,255,.9);margin-top:4px}
    .toast.bad .ticon{background:rgba(251,113,133,.9)}
    .toast.ok .ticon{background:rgba(52,211,153,.9)}
    .toast .ttext b{display:block;font-size:13px}
    .toast .ttext span{display:block;font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
    dialog{border:1px solid var(--border2);border-radius:18px;background:rgba(15,22,41,.94);color:var(--text);padding:0;width:min(780px, calc(100vw - 24px));box-shadow:0 30px 80px rgba(0,0,0,.65)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlghead{padding:14px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
    .dlghead h3{margin:0;font-size:14px}
    .dlgbody{padding:14px}
    .dlgfoot{padding:12px 14px;border-top:1px solid var(--border2);display:flex;justify-content:flex-end;gap:8px}
    .notice{padding:10px 12px;border-radius:14px;border:1px solid var(--border2);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;line-height:1.45}
    @media (max-width:980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr}
      .sidebar{position:sticky;top:0;z-index:5}
      .search{width:100%}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>TellerDesk</h1>
          <small>창구(텔러) 업무 콘솔 • 단일 HTML 데모</small>
        </div>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="dashboard"><span class="dot"></span>대시보드</button>
        <button data-view="cash"><span class="dot"></span>1) 입출금·이체·조회</button>
        <button data-view="deposit"><span class="dot"></span>2) 예금·예적금</button>
        <button data-view="autopay"><span class="dot"></span>3) 자동이체·자동납부</button>
        <button data-view="bills"><span class="dot"></span>4) 공과금·지로·세금</button>
        <button data-view="reports"><span class="dot"></span>5) 제신고(사고/변경)</button>
        <button data-view="security"><span class="dot"></span>6) 인터넷뱅킹·OTP</button>
        <button data-view="cards"><span class="dot"></span>7) 카드 업무</button>
        <button data-view="others"><span class="dot"></span>8) 기타(출력/변경)</button>
        <button data-view="legal"><span class="dot"></span>9) 특수(압류/가압류)</button>
        <button data-view="audit"><span class="dot"></span>감사로그</button>
      </div>

      <div class="sidebox">
        <h3>현재 선택</h3>
        <div class="chiprow">
          <span class="chip">고객 <strong id="chipCustomer">—</strong></span>
          <span class="chip">계좌 <strong id="chipAccount">—</strong></span>
          <span class="chip">권한 <strong id="chipRole">—</strong></span>
        </div>
      </div>

      <div class="sidebox">
        <h3>데이터</h3>
        <div class="chiprow">
          <button class="btn" id="btnSave">저장</button>
          <button class="btn" id="btnLoad">불러오기</button>
          <button class="btn danger" id="btnReset">초기화</button>
        </div>
        <div class="mini" style="margin-top:8px">온라인 저장(Identity+Blobs) / 오프라인(localStorage)</div>
      </div>

      <footer>
        <div>단축키: <span class="kbd">/</span> 검색 · <span class="kbd">Esc</span> 닫기</div>
        <div class="muted">※ 실제 은행 연동/실데이터 없이 UI/흐름 구현용</div>
      </footer>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="crumbs">
          <div class="title" id="pageTitle">대시보드</div>
          <div class="sub" id="pageSub">오늘의 업무 요약 · 빠른 작업</div>
        </div>

        <div class="actions">
          <div class="search" title="고객/계좌 검색">
            <span class="kbd">/</span>
            <input id="globalSearch" placeholder="고객명/고객번호/계좌번호 검색 (예: 선우 / C-1001 / 110-...)" />
            <span class="kbd">Enter</span>
          </div>

          <div class="pill" id="userPill" title="사용자 정보 변경">
            <div class="avatar" aria-hidden="true"></div>
            <div>
              <div style="font-weight:700; font-size:13px" id="userName">—</div>
              <small id="userMeta">—</small>
            </div>
          </div>

          <button class="btn primary" id="btnTellerLogin" title="Netlify Identity 로그인">로그인</button>
          <button class="btn" id="btnTellerLogout" title="로그아웃" style="display:none">로그아웃</button>
        </div>
      </header>

      <div class="content">
        <!-- Dashboard -->
        <section class="view active" data-view="dashboard">
          <div class="grid">
            <div class="card">
              <div class="head">
                <div>
                  <h2>오늘 요약</h2>
                  <p>고객/계좌 선택 후 업무 처리. 아래에서 고객/계좌를 “추가 생성”도 가능.</p>
                </div>
                <span class="tag ok">OFFLINE</span>
              </div>
              <div class="body">
                <div class="split" style="margin-bottom:10px">
                  <div class="stat"><b id="statTx">0건</b><span>전체 거래(데모)</span></div>
                  <div class="stat"><b id="statCash">₩0</b><span>선택 계좌 잔액</span></div>
                  <div class="stat"><b id="statAlerts">0건</b><span>주의/보류(데모)</span></div>
                </div>

                <div class="row">
                  <div class="field">
                    <label>고객 선택</label>
                    <select id="customerSelect"></select>
                  </div>
                  <div class="field">
                    <label>계좌 선택</label>
                    <select id="accountSelect"></select>
                  </div>
                </div>

                <div class="btnrow">
                  <button class="btn primary" data-jump="cash">입/출금·이체</button>
                  <button class="btn" data-jump="deposit">예적금/상품가입</button>
                  <button class="btn" data-jump="reports">제신고</button>
                  <button class="btn" data-jump="bills">공과금/세금</button>
                  <button class="btn ghost" data-jump="audit">감사로그</button>
                </div>

                <div class="notice" style="margin-top:12px">
                  <b style="color:rgba(255,255,255,.9)">추가 기능 넣어둠</b><br>
                  • 고객/계좌 “생성” (데모) · • 계좌 상태 변경(정상/정지) · • 영수증/확인서 “프린트 미리보기” · • 감사로그 CSV 내보내기
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <div>
                  <h2>최근 거래</h2>
                  <p>선택 계좌 기준 최근 8건</p>
                </div>
              </div>
              <div class="body">
                <table>
                  <thead><tr><th>시간</th><th>유형</th><th>금액</th><th>메모</th></tr></thead>
                  <tbody id="recentTxBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div class="card">
              <div class="head">
                <div>
                  <h2>고객 생성(데모)</h2>
                  <p>창구에서 신규 고객 등록 흐름</p>
                </div>
                <span class="tag">TLR-CUST</span>
              </div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>고객명</label><input id="newCustName" placeholder="예: 김선우" /></div>
                  <div class="field"><label>연락처</label><input id="newCustPhone" placeholder="예: 010-0000-0000" /></div>
                  <div class="field"><label>메모</label><input id="newCustNote" placeholder="예: 신규" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnAddCustomer">고객 등록</button>
                  <span class="mini">등록 즉시 선택됨</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <div>
                  <h2>계좌 생성/상태</h2>
                  <p>선택 고객에 입출금 계좌 추가 + 상태 변경</p>
                </div>
                <span class="tag">TLR-ACCT</span>
              </div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>계좌번호(데모)</label><input id="newAcctNo" placeholder="예: 110-0000-0000" /></div>
                  <div class="field"><label>초기 잔액</label><input id="newAcctBal" type="number" min="0" placeholder="예: 50000" /></div>
                  <div class="field"><label>상태</label>
                    <select id="acctStatusSelect"><option>정상</option><option>정지</option></select>
                  </div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnAddAccount">계좌 개설</button>
                  <button class="btn" id="btnSetAcctStatus">상태 변경</button>
                  <span class="mini">정지면 출금/이체 거절</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 1) Cash -->
        <section class="view" data-view="cash">
          <div class="grid">
            <div class="card">
              <div class="head">
                <div>
                  <h2>입출금·이체</h2>
                  <p>기본 출납 + 계좌송금. (정지 계좌는 출금/이체 불가)</p>
                </div>
                <span class="tag">TLR-CASH</span>
              </div>
              <div class="body">
                <div class="row">
                  <div class="field"><label>입금 금액</label><input id="depAmount" type="number" min="0" placeholder="예: 50000" /></div>
                  <div class="field"><label>입금 메모</label><input id="depMemo" placeholder="예: 현금 입금" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnDeposit">입금 처리</button>
                  <button class="btn" id="btnReceipt">영수증 미리보기</button>
                </div>

                <hr style="border:0;border-top:1px solid var(--border2); margin:14px 0">

                <div class="row">
                  <div class="field"><label>출금 금액</label><input id="wdAmount" type="number" min="0" placeholder="예: 20000" /></div>
                  <div class="field"><label>출금 메모</label><input id="wdMemo" placeholder="예: 현금 출금" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn danger" id="btnWithdraw">출금 처리</button>
                  <button class="btn" id="btnReceipt2">영수증 미리보기</button>
                </div>

                <hr style="border:0;border-top:1px solid var(--border2); margin:14px 0">

                <div class="row3">
                  <div class="field"><label>이체 금액</label><input id="trAmount" type="number" min="0" placeholder="예: 10000" /></div>
                  <div class="field"><label>받는 계좌(데모)</label><select id="toAccountSelect"></select></div>
                  <div class="field"><label>이체 메모</label><input id="trMemo" placeholder="예: 이체" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnTransfer">이체 처리</button>
                  <button class="btn" id="btnReceipt3">영수증 미리보기</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <div>
                  <h2>조회</h2>
                  <p>잔액/거래내역/계좌 상태</p>
                </div>
                <span class="tag">TLR-INQ</span>
              </div>
              <div class="body">
                <div class="split" style="margin-bottom:10px">
                  <div class="stat"><b id="balNow">₩0</b><span>현재 잔액</span></div>
                  <div class="stat"><b id="acctStatus">—</b><span>계좌 상태</span></div>
                </div>
                <table>
                  <thead><tr><th>시간</th><th>유형</th><th>금액</th><th>메모</th></tr></thead>
                  <tbody id="txTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 2) Deposit/Savings -->
        <section class="view" data-view="deposit">
          <div class="grid">
            <div class="card">
              <div class="head">
                <div>
                  <h2>예금·예적금 / 상품 가입</h2>
                  <p>정기예금/적금 등 “상품 가입” 흐름 UI (데모)</p>
                </div>
                <span class="tag">TLR-DEP</span>
              </div>
              <div class="body">
                <div class="row3">
                  <div class="field">
                    <label>상품</label>
                    <select id="prodType">
                      <option>정기예금(12개월)</option>
                      <option>정기예금(24개월)</option>
                      <option>정기적금(12개월)</option>
                      <option>자유적금(6개월)</option>
                    </select>
                  </div>
                  <div class="field"><label>가입금액</label><input id="prodAmount" type="number" min="0" placeholder="예: 300000" /></div>
                  <div class="field"><label>자동이체 연결(선택)</label>
                    <select id="prodAuto"><option value="">안 함</option><option>매월 25일</option><option>매월 말일</option></select>
                  </div>
                </div>
                <div class="row">
                  <div class="field"><label>가입 메모</label><input id="prodMemo" placeholder="예: 신규 가입" /></div>
                  <div class="field"><label>만기 처리(데모)</label>
                    <select id="maturityAction"><option>원리금 자동 재예치</option><option>만기 해지(지급계좌로)</option><option>만기 안내만</option></select>
                  </div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnJoinProduct">상품 가입 처리</button>
                  <button class="btn" id="btnCloseProduct">해지/만기 처리(데모)</button>
                  <button class="btn" id="btnConfirmDoc">가입 확인서 미리보기</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head"><div><h2>가입 내역</h2><p>선택 고객 기준 최근 가입 내역(데모)</p></div><span class="tag">TLR-DEP-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>상품</th><th>금액</th><th>상태</th><th>메모</th></tr></thead>
                  <tbody id="prodBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 3) Auto transfer -->
        <section class="view" data-view="autopay">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>자동이체·자동납부</h2><p>등록/변경/해지 (데모)</p></div><span class="tag">TLR-AUTO</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>유형</label>
                    <select id="autoType"><option>자동이체(계좌)</option><option>자동납부(공과금)</option></select>
                  </div>
                  <div class="field"><label>금액</label><input id="autoAmount" type="number" min="0" placeholder="예: 15000" /></div>
                  <div class="field"><label>주기</label>
                    <select id="autoCycle"><option>매월 25일</option><option>매주 월요일</option><option>매일</option></select>
                  </div>
                </div>
                <div class="row">
                  <div class="field"><label>수취/납부처</label><input id="autoTarget" placeholder="예: KB 123-45-6789 / 수도요금" /></div>
                  <div class="field"><label>메모</label><input id="autoMemo" placeholder="예: 등록" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnAutoAdd">등록</button>
                  <button class="btn" id="btnAutoEdit">변경(데모)</button>
                  <button class="btn danger" id="btnAutoDel">해지</button>
                  <button class="btn" id="btnAutoDoc">확인서 미리보기</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head"><div><h2>자동 처리 목록</h2><p>선택 계좌 기준</p></div><span class="tag">TLR-AUTO-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>상태</th><th>유형</th><th>금액</th><th>주기</th><th>수취/납부처</th><th>메모</th></tr></thead>
                  <tbody id="autoBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Bills -->
        <section class="view" data-view="bills">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>공과금·지로·세금·등록금 납부</h2><p>수납 UI (데모)</p></div><span class="tag">TLR-BILL</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>납부 종류</label>
                    <select id="billType"><option>지로/공과금</option><option>국세/국고</option><option>지방세</option><option>아파트 관리비</option><option>대학 등록금</option></select>
                  </div>
                  <div class="field"><label>납부 금액</label><input id="billAmount" type="number" min="0" placeholder="예: 54000" /></div>
                  <div class="field"><label>고지번호(데모)</label><input id="billRef" placeholder="예: 2026-001-9988" /></div>
                </div>
                <div class="row">
                  <div class="field"><label>납부처</label><input id="billTo" placeholder="예: 서울시/전기요금/학교" /></div>
                  <div class="field"><label>메모</label><input id="billMemo" placeholder="예: 창구 납부" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnBillPay">납부 처리</button>
                  <button class="btn" id="btnBillPrint">영수증 미리보기</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head"><div><h2>수납 내역</h2><p>최근 납부 기록(데모)</p></div><span class="tag">TLR-BILL-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>시간</th><th>종류</th><th>금액</th><th>고지번호</th><th>납부처</th></tr></thead>
                  <tbody id="billBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 5) Reports -->
        <section class="view" data-view="reports">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>제신고(사고/변경)</h2><p>분실/재발행/비번 변경/오류 해제(데모)</p></div><span class="tag">TLR-RPT</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>업무</label>
                    <select id="rptType">
                      <option>통장 비밀번호 변경</option><option>비밀번호 오류횟수 해제</option><option>통장 분실 신고</option>
                      <option>인감/서명 분실 신고</option><option>통장 재발행</option><option>사고해제(분실 해제)</option>
                    </select>
                  </div>
                  <div class="field"><label>본인확인(데모)</label>
                    <select id="kyc"><option>신분증 확인 완료</option><option>대리인(위임장 확인)</option><option>추가 확인 필요</option></select>
                  </div>
                  <div class="field"><label>접수 메모</label><input id="rptMemo" placeholder="예: 본인 방문, 통장 분실" /></div>
                </div>
                <div class="field" style="margin-top:10px"><label>상세 사유/비고</label><textarea id="rptDetail" placeholder="예: 분실 경위, 교부 방식, 확인사항"></textarea></div>
                <div class="btnrow">
                  <button class="btn primary" id="btnRptSubmit">접수/처리</button>
                  <button class="btn" id="btnRptPrint">확인서 미리보기</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="head"><div><h2>제신고 처리내역</h2><p>최근 접수(데모)</p></div><span class="tag">TLR-RPT-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>업무</th><th>본인확인</th><th>상태</th><th>메모</th></tr></thead>
                  <tbody id="rptBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 6) Security -->
        <section class="view" data-view="security">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>인터넷뱅킹·OTP·이체한도</h2><p>신규/해지, 보안매체, 한도 변경(데모)</p></div><span class="tag">TLR-SEC</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>업무</label>
                    <select id="secType">
                      <option>인터넷뱅킹 신규</option><option>인터넷뱅킹 해지</option><option>OTP 발급</option>
                      <option>타기관 OTP 등록</option><option>보안매체 분실</option><option>이체한도 변경</option>
                    </select>
                  </div>
                  <div class="field"><label>한도(선택)</label><input id="secLimit" type="number" min="0" placeholder="예: 1000000" /></div>
                  <div class="field"><label>메모</label><input id="secMemo" placeholder="예: 신규 발급" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnSecSubmit">처리</button>
                  <button class="btn" id="btnSecPrint">확인서 미리보기</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="head"><div><h2>보안/한도 처리내역</h2><p>최근 기록(데모)</p></div><span class="tag">TLR-SEC-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>업무</th><th>값(한도)</th><th>상태</th><th>메모</th></tr></thead>
                  <tbody id="secBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 7) Cards -->
        <section class="view" data-view="cards">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>카드 업무</h2><p>체크카드 신규/재발급/잠금/비번 변경(데모)</p></div><span class="tag">TLR-CARD</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>업무</label>
                    <select id="cardType">
                      <option>체크카드 신규</option><option>재발급</option><option>분실 신고</option><option>분실 해제</option>
                      <option>비밀번호 변경</option><option>결제계좌 변경</option><option>이용한도 변경</option>
                    </select>
                  </div>
                  <div class="field"><label>값(선택)</label><input id="cardValue" placeholder="예: 한도 50만원 / 결제계좌 변경" /></div>
                  <div class="field"><label>메모</label><input id="cardMemo" placeholder="예: 고객 요청" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnCardSubmit">처리</button>
                  <button class="btn" id="btnCardPrint">접수증 미리보기</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="head"><div><h2>카드 처리내역</h2><p>최근 기록(데모)</p></div><span class="tag">TLR-CARD-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>업무</th><th>값</th><th>상태</th><th>메모</th></tr></thead>
                  <tbody id="cardBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 8) Others -->
        <section class="view" data-view="others">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>기타(내정보 변경·출력)</h2><p>연락처/주소/이메일 변경, 증명서 출력(데모)</p></div><span class="tag">TLR-MISC</span></div>
              <div class="body">
                <div class="row">
                  <div class="field"><label>변경/출력 항목</label>
                    <select id="miscType">
                      <option>연락처 변경</option><option>주소 변경</option><option>이메일 변경</option>
                      <option>통장사본 출력</option><option>거래내역 출력</option><option>잔액증명서 출력</option>
                    </select>
                  </div>
                  <div class="field"><label>값/메모</label><input id="miscValue" placeholder="예: 010-1234-5678 / 출력 1부" /></div>
                </div>
                <div class="btnrow">
                  <button class="btn primary" id="btnMiscSubmit">처리</button>
                  <button class="btn" id="btnMiscPrint">문서 미리보기</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="head"><div><h2>기타 처리내역</h2><p>최근 기록(데모)</p></div><span class="tag">TLR-MISC-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>업무</th><th>값</th><th>상태</th><th>메모</th></tr></thead>
                  <tbody id="miscBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 9) Legal -->
        <section class="view" data-view="legal">
          <div class="grid">
            <div class="card">
              <div class="head"><div><h2>특수 처리(압류/가압류/추심 등)</h2><p>문서 접수 → 제한 → 통지/해제 (데모)</p></div><span class="tag warn">TLR-LEGAL</span></div>
              <div class="body">
                <div class="row3">
                  <div class="field"><label>업무</label>
                    <select id="legType"><option>압류 등록</option><option>가압류 등록</option><option>추심(지급) 처리</option><option>해제 처리</option><option>문서 보완 요청</option></select>
                  </div>
                  <div class="field"><label>문서번호(데모)</label><input id="legDoc" placeholder="예: COURT-2026-0001" /></div>
                  <div class="field"><label>조치</label>
                    <select id="legAction"><option>계좌 지급정지</option><option>부분 제한</option><option>통지 발송</option><option>해제</option></select>
                  </div>
                </div>
                <div class="field" style="margin-top:10px"><label>비고</label><textarea id="legMemo" placeholder="예: 명령서 확인, 대상 계좌, 통지 여부 등"></textarea></div>
                <div class="btnrow">
                  <button class="btn primary" id="btnLegSubmit">접수/처리</button>
                  <button class="btn" id="btnLegPrint">확인서 미리보기</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="head"><div><h2>특수 처리내역</h2><p>최근 기록(데모)</p></div><span class="tag warn">LEGAL-LIST</span></div>
              <div class="body">
                <table>
                  <thead><tr><th>일시</th><th>업무</th><th>문서번호</th><th>조치</th><th>상태</th></tr></thead>
                  <tbody id="legBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Audit -->
        <section class="view" data-view="audit">
          <div class="card">
            <div class="head"><div><h2>감사 로그</h2><p>누가 언제 어떤 업무를 했는지 기록(데모)</p></div><span class="tag">AUDIT</span></div>
            <div class="body">
              <div class="row">
                <div class="field"><label>필터(키워드)</label><input id="auditFilter" placeholder="예: 입금 / 제신고 / C-1001 / 110-..." /></div>
                <div class="field">
                  <label>빠른 작업</label>
                  <div class="btnrow" style="margin-top:0">
                    <button class="btn" id="btnAuditCSV">CSV 내보내기</button>
                    <button class="btn danger" id="btnAuditClear">로그 초기화</button>
                  </div>
                </div>
              </div>
              <div style="margin-top:10px">
                <table>
                  <thead><tr><th>시간</th><th>사용자</th><th>업무</th><th>고객</th><th>계좌</th><th>상세</th></tr></thead>
                  <tbody id="auditBody"></tbody>
                </table>
              </div>
              <div class="mini" style="margin-top:10px">※ 데모는 “주요 처리” 위주로 감사로그 기록</div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Search picker -->
  <dialog id="picker">
    <div class="dlghead">
      <h3>검색 결과</h3>
      <button class="btn" id="btnClosePicker">닫기</button>
    </div>
    <div class="dlgbody">
      <div class="field"><label>결과</label><div id="pickerList"></div></div>
    </div>
    <div class="dlgfoot">
      <button class="btn" id="btnPickerOk">확인</button>
    </div>
  </dialog>

  <!-- User edit -->
  <dialog id="userDlg">
    <div class="dlghead">
      <h3>사용자(텔러) 설정</h3>
      <button class="btn" id="btnUserClose">닫기</button>
    </div>
    <div class="dlgbody">
      <div class="row">
        <div class="field"><label>이름</label><input id="inpUserName" placeholder="예: 이선우" /></div>
        <div class="field"><label>지점</label><input id="inpBranch" placeholder="예: 001" /></div>
      </div>
      <div class="row">
        <div class="field"><label>권한</label>
          <select id="inpRole"><option>Teller</option><option>Supervisor</option><option>Compliance</option></select>
        </div>
        <div class="field"><label>메모</label><input id="inpUserNote" placeholder="예: 데모 계정" /></div>
      </div>
      <div class="notice" style="margin-top:10px">역할은 UI 표시용(데모). 실제 권한제어는 다음 단계에서 붙이면 됨.</div>
    </div>
    <div class="dlgfoot">
      <button class="btn primary" id="btnUserSave">저장</button>
    </div>
  </dialog>

  <!-- Print preview -->
  <dialog id="printDlg">
    <div class="dlghead">
      <h3>문서 미리보기</h3>
      <button class="btn" id="btnPrintClose">닫기</button>
    </div>
    <div class="dlgbody">
      <div id="printArea" class="notice" style="font-family:var(--mono); white-space:pre-wrap"></div>
    </div>
    <div class="dlgfoot">
      <button class="btn primary" id="btnDoPrint">인쇄</button>
    </div>
  </dialog>

  <div class="toasts" id="toasts"></div>

  <script>
    const STORAGE_KEY = "tellerdesk_v1";
    // --- Netlify Identity + Online Storage(Blobs via Functions)
    let netlifyUser = null;

    async function api(action, payload = {}, method="POST"){
      const token = netlifyUser?.token?.access_token;
      const headers = { "Content-Type": "application/json" };
      if(token) headers["authorization"] = `Bearer ${token}`;
      const res = await fetch("/.netlify/functions/bank", {
        method,
        headers,
        body: JSON.stringify({ action, payload })
      });
      let data=null;
      try{ data = await res.json(); }catch(e){}
      if(!res.ok || !data?.ok){
        const msg = data?.error || data?.message || `요청 실패 (${res.status})`;
        throw new Error(msg);
      }
      return data;
    }

    function isIdentityReady(){
      return typeof window !== "undefined" && !!window.netlifyIdentity;
    }

    async function onlineLoad(silent=false){
      const data = await api("tellerDeskGet", {});
      const desk = data.desk;
      if(!desk){ if(!silent) toast("온라인 데이터 없음", "기본 데이터로 시작", "warn"); return false; }

      try{
        // state/db는 const 객체이므로 내부를 갱신
        Object.assign(state, desk.state || {});
        if(desk.db){
          for(const k of Object.keys(db)){
            if(desk.db[k] !== undefined) db[k] = desk.db[k];
          }
        }
        if(!silent) toast("온라인 불러오기", "복원 완료", "ok");
        return true;
      }catch(e){
        if(!silent) toast("온라인 불러오기 실패", String(e), "bad");
        return false;
      }
    }

    async function onlineSave(){
      await api("tellerDeskSet", { desk: { state, db } });
      toast("온라인 저장 완료", "Netlify Blobs에 저장했어", "ok");
      audit("온라인 저장", state.selectedCustomerId, currentAccount()?.no, "");
    }

    async function onlineReset(){
      await api("tellerDeskReset", {});
      toast("온라인 초기화", "초기 상태로 리셋했어", "ok");
      location.reload();
    }


    const nowISO = () => new Date().toISOString();
    const fmtTime = (d=new Date()) => {
      const pad=n=>String(n).padStart(2,'0');
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    };
    const money = (n) => "₩" + Number(n||0).toLocaleString("ko-KR");
    const uid = (p="ID") => `${p}-${Math.random().toString(16).slice(2,8).toUpperCase()}-${Date.now().toString().slice(-4)}`;
    const $ = (q,el=document)=>el.querySelector(q);
    const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
    const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

    const state = { user:{ name:"이선우", branch:"001", role:"Teller", note:"" }, selectedCustomerId:null, selectedAccountId:null, alerts:0 };
    const db = {
      customers:[
        { id:"C-1001", name:"선우", phone:"010-1234-5678", note:"우대 고객(데모)" },
        { id:"C-1002", name:"모락", phone:"010-2222-3333", note:"" },
        { id:"C-1003", name:"하늘", phone:"010-9999-0000", note:"" },
      ],
      accounts:[
        { id:"A-2001", no:"110-1234-5678", customerId:"C-1001", type:"입출금", status:"정상", balance:180000 },
        { id:"A-2002", no:"110-5555-7777", customerId:"C-1001", type:"입출금", status:"정상", balance:32000 },
        { id:"A-2003", no:"220-1010-2020", customerId:"C-1002", type:"입출금", status:"정상", balance:89000 },
        { id:"A-2004", no:"330-0000-1111", customerId:"C-1003", type:"입출금", status:"정상", balance:540000 },
      ],
      transactions:[],
      products:[], autopays:[], bills:[], reports:[], security:[], cards:[], misc:[], legal:[], audit:[]
    };

    function toast(title, detail="", variant=""){
      const wrap = $("#toasts");
      const t = document.createElement("div");
      t.className = `toast ${variant}`.trim();
      t.innerHTML = `<div class="ticon"></div><div class="ttext"><b>${escapeHtml(title)}</b><span>${escapeHtml(detail)}</span></div>`;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 2800);
      setTimeout(()=>{ t.remove(); }, 3300);
    }
    function audit(action, customerId, accountNo, detail){
      db.audit.unshift({
        id: uid("AU"), time: fmtTime(), actor: state.user.name,
        action, customerId: customerId||"—", accountId: accountNo||"—", detail: detail||""
      });
      renderAudit();
    }
    function currentCustomer(){ return db.customers.find(c=>c.id===state.selectedCustomerId) || null; }
    function currentAccount(){ return db.accounts.find(a=>a.id===state.selectedAccountId) || null; }

    // --- Seed
    (function seed(){
      const acct = db.accounts[0];
      const seedTx = [
        { type:"입금", amount: 50000, memo:"현금 입금" },
        { type:"출금", amount: 12000, memo:"현금 출금" },
        { type:"이체", amount: 10000, memo:"이체" },
      ];
      seedTx.forEach((t,i)=>{
        const time = new Date(Date.now() - (seedTx.length-i)*600000);
        db.transactions.unshift({ id: uid("TX"), at: time.toISOString(), time: fmtTime(time), accountId: acct.id, type: t.type, amount: t.amount, memo: t.memo });
        if(t.type==="입금") acct.balance += t.amount; else acct.balance -= t.amount;
      });
      audit("초기 데이터 로드", null, null, "데모 시드 완료");
    })();

    // --- Navigation
    const titles = {
      dashboard:["대시보드","오늘의 업무 요약 · 빠른 작업"],
      cash:["1) 입출금·이체·조회","출납/이체/조회 (데모)"],
      deposit:["2) 예금·예적금","상품 가입/해지/만기 (데모)"],
      autopay:["3) 자동이체·자동납부","등록/변경/해지 (데모)"],
      bills:["4) 공과금·지로·세금","수납/영수증 (데모)"],
      reports:["5) 제신고","사고/변경/재발행 (데모)"],
      security:["6) 인터넷뱅킹·OTP","보안매체/한도 (데모)"],
      cards:["7) 카드 업무","신규/재발급/잠금 (데모)"],
      others:["8) 기타","내정보 변경/문서 출력 (데모)"],
      legal:["9) 특수 처리","압류/가압류/해제 (데모)"],
      audit:["감사로그","처리/기록 조회 (데모)"],
    };
    function setView(key){
      $$("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.view===key));
      $$(".view").forEach(v=>v.classList.toggle("active", v.dataset.view===key));
      $("#pageTitle").textContent = titles[key]?.[0] || key;
      $("#pageSub").textContent = titles[key]?.[1] || "";
      audit(`화면 이동: ${titles[key]?.[0]||key}`, state.selectedCustomerId, currentAccount()?.no, "");
      renderAll();
    }

    // --- Select rendering
    function renderUser(){
      $("#userName").textContent = state.user.name;
      $("#userMeta").textContent = `Branch ${state.user.branch} · ${state.user.role}`;
      $("#chipRole").textContent = state.user.role;
    }
    function renderCustomerSelect(){
      const sel = $("#customerSelect");
      sel.innerHTML = db.customers.map(c=>`<option value="${c.id}">${c.name} (${c.id})</option>`).join("");
      if(!state.selectedCustomerId) state.selectedCustomerId = db.customers[0]?.id || null;
      sel.value = state.selectedCustomerId || "";
    }
    function renderAccountSelect(){
      const custId = state.selectedCustomerId;
      const accts = db.accounts.filter(a=>a.customerId===custId);
      const sel = $("#accountSelect");
      sel.innerHTML = accts.map(a=>`<option value="${a.id}">${a.no} · ${a.type} · ${a.status} · ${money(a.balance)}</option>`).join("");
      if(!state.selectedAccountId || !accts.some(a=>a.id===state.selectedAccountId)){
        state.selectedAccountId = accts[0]?.id || null;
      }
      sel.value = state.selectedAccountId || "";
      // transfer target list
      const toSel = $("#toAccountSelect");
      const others = db.accounts.filter(a=>a.id !== state.selectedAccountId);
      toSel.innerHTML = others.map(a=>{
        const c = db.customers.find(x=>x.id===a.customerId);
        return `<option value="${a.id}">${a.no} · ${c?.name||"—"}</option>`;
      }).join("");
      // dashboard acct status selector sync
      $("#acctStatusSelect").value = currentAccount()?.status || "정상";
    }
    function renderChips(){
      const c = currentCustomer();
      const a = currentAccount();
      $("#chipCustomer").textContent = c ? `${c.name} (${c.id})` : "—";
      $("#chipAccount").textContent = a ? `${a.no}` : "—";
      $("#balNow").textContent = a ? money(a.balance) : "₩0";
      $("#acctStatus").textContent = a ? a.status : "—";
      $("#statCash").textContent = a ? money(a.balance) : "₩0";
      $("#statTx").textContent = `${db.transactions.length}건`;
      $("#statAlerts").textContent = `${state.alerts}건`;
    }

    function txForSelected(){
      const a = currentAccount(); if(!a) return [];
      return db.transactions.filter(t=>t.accountId===a.id).slice(0).sort((x,y)=> y.at.localeCompare(x.at));
    }
    function renderTxTables(){
      const rows = txForSelected().slice(0,12).map(t=>`
        <tr>
          <td>${escapeHtml(t.time)}</td>
          <td><span class="tag ${t.type==="입금"?"ok":t.type==="출금"?"bad":"warn"}">${escapeHtml(t.type)}</span></td>
          <td>${money(t.amount)}</td>
          <td class="muted">${escapeHtml(t.memo||"")}</td>
        </tr>`).join("");
      $("#txTableBody").innerHTML = rows || `<tr><td colspan="4" class="muted">거래 내역이 없어요.</td></tr>`;

      const recent = txForSelected().slice(0,8).map(t=>`
        <tr><td>${escapeHtml(t.time)}</td><td>${escapeHtml(t.type)}</td><td>${money(t.amount)}</td><td class="muted">${escapeHtml(t.memo||"")}</td></tr>
      `).join("");
      $("#recentTxBody").innerHTML = recent || `<tr><td colspan="4" class="muted">최근 거래가 없어요.</td></tr>`;
    }

    function renderLists(){
      $("#prodBody").innerHTML = (db.products.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(p=>`
        <tr><td>${escapeHtml(p.time)}</td><td>${escapeHtml(p.product)}</td><td>${money(p.amount)}</td><td><span class="tag ok">${escapeHtml(p.status)}</span></td><td class="muted">${escapeHtml(p.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">가입 내역이 없어요.</td></tr>`;

      $("#autoBody").innerHTML = (db.autopays.filter(x=>x.accountId===state.selectedAccountId).slice(0,10).map(a=>`
        <tr><td><span class="tag ${a.status==="활성"?"ok":"warn"}">${escapeHtml(a.status)}</span></td><td>${escapeHtml(a.type)}</td><td>${money(a.amount)}</td><td>${escapeHtml(a.cycle)}</td><td class="muted">${escapeHtml(a.target)}</td><td class="muted">${escapeHtml(a.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="6" class="muted">등록된 자동이체/납부가 없어요.</td></tr>`;

      $("#billBody").innerHTML = (db.bills.filter(x=>x.accountId===state.selectedAccountId).slice(0,10).map(b=>`
        <tr><td>${escapeHtml(b.time)}</td><td>${escapeHtml(b.type)}</td><td>${money(b.amount)}</td><td class="muted">${escapeHtml(b.ref)}</td><td class="muted">${escapeHtml(b.to)}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">수납 내역이 없어요.</td></tr>`;

      $("#rptBody").innerHTML = (db.reports.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(r=>`
        <tr><td>${escapeHtml(r.time)}</td><td>${escapeHtml(r.type)}</td><td class="muted">${escapeHtml(r.kyc)}</td><td><span class="tag ok">처리</span></td><td class="muted">${escapeHtml(r.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">제신고 내역이 없어요.</td></tr>`;

      $("#secBody").innerHTML = (db.security.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(s=>`
        <tr><td>${escapeHtml(s.time)}</td><td>${escapeHtml(s.type)}</td><td class="muted">${escapeHtml(s.value||"—")}</td><td><span class="tag ok">처리</span></td><td class="muted">${escapeHtml(s.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">처리 내역이 없어요.</td></tr>`;

      $("#cardBody").innerHTML = (db.cards.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(c=>`
        <tr><td>${escapeHtml(c.time)}</td><td>${escapeHtml(c.type)}</td><td class="muted">${escapeHtml(c.value||"—")}</td><td><span class="tag ok">처리</span></td><td class="muted">${escapeHtml(c.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">처리 내역이 없어요.</td></tr>`;

      $("#miscBody").innerHTML = (db.misc.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(m=>`
        <tr><td>${escapeHtml(m.time)}</td><td>${escapeHtml(m.type)}</td><td class="muted">${escapeHtml(m.value||"—")}</td><td><span class="tag ok">처리</span></td><td class="muted">${escapeHtml(m.memo||"")}</td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">처리 내역이 없어요.</td></tr>`;

      $("#legBody").innerHTML = (db.legal.filter(x=>x.customerId===state.selectedCustomerId).slice(0,10).map(l=>`
        <tr><td>${escapeHtml(l.time)}</td><td>${escapeHtml(l.type)}</td><td class="muted">${escapeHtml(l.doc)}</td><td class="muted">${escapeHtml(l.action)}</td><td><span class="tag warn">특수</span></td></tr>
      `).join("")) || `<tr><td colspan="5" class="muted">특수 처리내역이 없어요.</td></tr>`;
    }

    function renderAudit(){
      const kw = ($("#auditFilter")?.value || "").trim().toLowerCase();
      const list = kw ? db.audit.filter(a => JSON.stringify(a).toLowerCase().includes(kw)) : db.audit;
      $("#auditBody").innerHTML = (list.slice(0,120).map(a=>`
        <tr><td>${escapeHtml(a.time)}</td><td>${escapeHtml(a.actor)}</td><td>${escapeHtml(a.action)}</td><td class="muted">${escapeHtml(a.customerId)}</td><td class="muted">${escapeHtml(a.accountId)}</td><td class="muted">${escapeHtml(a.detail)}</td></tr>
      `).join("")) || `<tr><td colspan="6" class="muted">로그가 없어요.</td></tr>`;
    }

    function renderAll(){ renderUser(); renderChips(); renderTxTables(); renderLists(); }

    // --- Business rules
    function requireAccount(){
      const a = currentAccount();
      if(!a){ toast("계좌 선택 필요", "대시보드에서 고객/계좌 먼저", "bad"); return null; }
      return a;
    }
    function canDebit(a){
      if(a.status !== "정상"){
        state.alerts += 1;
        toast("정지 계좌", "출금/이체 불가", "bad");
        audit("출금/이체 거절(정지)", state.selectedCustomerId, a.no, "");
        return false;
      }
      return true;
    }
    function addTx(type, amount, memo, extraDetail=""){
      const a = requireAccount(); if(!a) return false;
      const amt = Number(amount||0);
      if(!Number.isFinite(amt) || amt<=0){ toast("금액 오류", "0보다 큰 숫자", "bad"); return false; }

      if((type==="출금" || type==="이체") && !canDebit(a)) return false;
      if((type==="출금" || type==="이체") && a.balance < amt){
        state.alerts += 1;
        toast("잔액 부족", `현재 ${money(a.balance)} · 요청 ${money(amt)}`, "bad");
        audit(`${type} 거절(잔액부족)`, state.selectedCustomerId, a.no, `요청 ${money(amt)} ${extraDetail}`.trim());
        renderAll();
        return false;
      }

      if(type==="입금") a.balance += amt; else a.balance -= amt;
      const t = { id: uid("TX"), at: nowISO(), time: fmtTime(), accountId: a.id, type, amount: amt, memo: memo||"" };
      db.transactions.unshift(t);
      toast(`${type} 완료`, `${money(amt)} · ${memo||"—"}`, type==="입금"?"ok":type==="출금"?"bad":"");
      audit(`${type} 처리`, state.selectedCustomerId, a.no, `${money(amt)} · ${memo||""} ${extraDetail}`.trim());
      renderAll();
      return true;
    }

    // --- Print preview (simple)
    const printDlg = $("#printDlg");
    function openPrint(title, lines){
      const c = currentCustomer(), a = currentAccount();
      const head = [
        `문서: ${title}`,
        `시간: ${new Date().toLocaleString("ko-KR")}`,
        `텔러: ${state.user.name} (지점 ${state.user.branch})`,
        `고객: ${c?`${c.name} (${c.id})`: "—"}`,
        `계좌: ${a?`${a.no} · 상태 ${a.status}`:"—"}`,
        `----------------------------------------`,
        ...lines
      ].join("\n");
      $("#printArea").textContent = head;
      printDlg.showModal();
    }
    $("#btnDoPrint").addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      const text = $("#printArea").textContent;
      w.document.write(`<pre style="font-family: ui-monospace, Menlo, Consolas, monospace; padding: 16px; white-space: pre-wrap;">${escapeHtml(text)}</pre>`);
      w.document.close();
      w.focus();
      w.print();
    });
    $("#btnPrintClose").addEventListener("click", ()=> printDlg.close());

    // --- Search picker
    const picker = $("#picker");
    let pickerSelected = { customerId:null, accountId:null };
    function openPicker(results){
      const list = $("#pickerList");
      list.innerHTML = results.map(r=>{
        const kind = r.kind==="customer" ? "고객" : "계좌";
        const label = r.kind==="customer"
          ? `${r.customer.name} (${r.customer.id}) · ${r.customer.phone}`
          : `${r.account.no} · ${r.customer.name} (${r.customer.id}) · ${money(r.account.balance)}`;
        return `
          <div style="display:flex; gap:8px; align-items:center; padding:10px; border:1px solid var(--border2); border-radius:14px; background: rgba(255,255,255,.03); margin-bottom:8px;">
            <span class="tag">${kind}</span>
            <div style="flex:1">
              <div style="font-weight:700; font-size:13px">${escapeHtml(label)}</div>
              <div class="muted" style="font-size:12px; margin-top:2px">${escapeHtml(r.hint||"")}</div>
            </div>
            <button class="btn" data-pick="${r.kind}:${r.id}">선택</button>
          </div>`;
      }).join("") || `<div class="muted">검색 결과가 없어요.</div>`;
      $$("#pickerList [data-pick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [kind, id] = btn.dataset.pick.split(":");
          if(kind==="customer"){ pickerSelected.customerId = id; pickerSelected.accountId = null; }
          else{
            const acct = db.accounts.find(a=>a.id===id);
            pickerSelected.customerId = acct?.customerId || null;
            pickerSelected.accountId = acct?.id || null;
          }
          toast("선택됨", kind==="customer" ? `고객 ${id}` : `계좌 ${db.accounts.find(a=>a.id===id)?.no||id}`, "ok");
        });
      });
      pickerSelected = { customerId:null, accountId:null };
      picker.showModal();
    }
    function applySelection(item){
      if(item.kind==="customer"){
        state.selectedCustomerId = item.id;
        renderCustomerSelect(); renderAccountSelect();
        audit("고객 선택", state.selectedCustomerId, null, item.customer.name);
      }else{
        state.selectedCustomerId = item.customer.id;
        renderCustomerSelect(); renderAccountSelect();
        state.selectedAccountId = item.account.id;
        $("#accountSelect").value = state.selectedAccountId;
        audit("계좌 선택", state.selectedCustomerId, item.account.no, "");
      }
      renderAll();
      toast("선택 완료", `${currentCustomer()?.name||"—"} · ${currentAccount()?.no||"—"}`, "ok");
    }
    function doSearch(q){
      const query = (q||"").trim().toLowerCase();
      if(!query) return;
      const res = [];
      db.customers.forEach(c=>{
        if([c.id,c.name,c.phone].some(v=>String(v).toLowerCase().includes(query))){
          res.push({ kind:"customer", id:c.id, customer:c, hint:c.note });
        }
      });
      db.accounts.forEach(a=>{
        const c = db.customers.find(x=>x.id===a.customerId);
        if([a.no,a.id,a.type,a.status].some(v=>String(v).toLowerCase().includes(query))){
          res.push({ kind:"account", id:a.id, account:a, customer:c, hint:`${a.type} · 상태 ${a.status}` });
        }
      });
      if(res.length===1) applySelection(res[0]);
      else openPicker(res.slice(0,12));
    }

    // --- Persistence
    function snapshot(){
      return JSON.stringify({ state, db }, null, 0);
    }
    async function save(){
      try{
        if(netlifyUser) return await onlineSave();
      }catch(e){
        toast("온라인 저장 실패", e.message, "bad");
      }
      // fallback: local
      localStorage.setItem(STORAGE_KEY, snapshot());
      toast("저장 완료", "브라우저에 저장했어(오프라인)", "ok");
      audit("데이터 저장(오프라인)", state.selectedCustomerId, currentAccount()?.no, "");
    }
    async function load(){
      try{
        if(netlifyUser){
          const ok = await onlineLoad();
          if(ok){ init(true); return; }
        }
      }catch(e){
        toast("온라인 불러오기 실패", e.message, "bad");
      }
      // fallback: local
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ toast("저장 데이터 없음", "저장 먼저 해줘", "bad"); return; }
      try{
        const obj = JSON.parse(raw);
        Object.assign(state, obj.state || {});
        for(const k of Object.keys(db)){
          if(obj.db && obj.db[k]) db[k] = obj.db[k];
        }
        toast("불러오기 완료", "복원했어(오프라인)", "ok");
        audit("데이터 불러오기(오프라인)", state.selectedCustomerId, currentAccount()?.no, "");
        init(true);
      }catch(e){
        toast("불러오기 실패", String(e), "bad");
      }
    }
    async function resetAll(){
      try{
        if(netlifyUser) return await onlineReset();
      }catch(e){
        toast("온라인 초기화 실패", e.message, "bad");
      }
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
// --- CSV export
    function exportAuditCSV(){
      const header = ["time","actor","action","customerId","accountId","detail"];
      const rows = db.audit.map(a=>header.map(h=>String(a[h]??"").replaceAll('"','""')));
      const csv = [header.join(","), ...rows.map(r=>r.map(v=>`"${v}"`).join(","))].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "audit.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast("CSV 내보내기", "audit.csv 다운로드", "ok");
      audit("감사로그 CSV 내보내기", state.selectedCustomerId, currentAccount()?.no, "");
    }

    // --- Bind
    function bind(){
      $$("#nav button").forEach(btn=> btn.addEventListener("click", ()=> setView(btn.dataset.view)));
      $$("[data-jump]").forEach(b=> b.addEventListener("click", ()=> setView(b.dataset.jump)));

      $("#customerSelect").addEventListener("change", (e)=>{
        state.selectedCustomerId = e.target.value;
        audit("고객 변경", state.selectedCustomerId, null, "");
        renderAccountSelect(); renderAll();
      });
      $("#accountSelect").addEventListener("change", (e)=>{
        state.selectedAccountId = e.target.value;
        audit("계좌 변경", state.selectedCustomerId, currentAccount()?.no, "");
        renderAccountSelect(); renderAll();
      });

      // dashboard create customer/account/status
      $("#btnAddCustomer").addEventListener("click", ()=>{
        const name = ($("#newCustName").value||"").trim();
        const phone = ($("#newCustPhone").value||"").trim();
        if(!name){ toast("고객명 필요", "이름을 입력해줘", "bad"); return; }
        const id = `C-${Math.floor(1000 + Math.random()*9000)}`;
        db.customers.unshift({ id, name, phone: phone||"—", note: ($("#newCustNote").value||"").trim() });
        state.selectedCustomerId = id;
        $("#newCustName").value=""; $("#newCustPhone").value=""; $("#newCustNote").value="";
        renderCustomerSelect(); renderAccountSelect(); renderAll();
        audit("고객 등록", id, null, `${name} · ${phone||"—"}`);
        toast("고객 등록 완료", `${name} (${id})`, "ok");
      });
      $("#btnAddAccount").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","먼저 고객 선택","bad"); return; }
        const no = ($("#newAcctNo").value||"").trim();
        if(!no){ toast("계좌번호 필요","계좌번호 입력","bad"); return; }
        const bal = Number($("#newAcctBal").value||0);
        const id = `A-${Math.floor(2000 + Math.random()*9000)}`;
        db.accounts.unshift({ id, no, customerId:c.id, type:"입출금", status:"정상", balance: Math.max(0, bal) });
        state.selectedAccountId = id;
        $("#newAcctNo").value=""; $("#newAcctBal").value="";
        renderAccountSelect(); renderAll();
        audit("계좌 개설", c.id, no, `초기 ${money(bal)}`);
        toast("계좌 개설 완료", no, "ok");
      });
      $("#btnSetAcctStatus").addEventListener("click", ()=>{
        const a = requireAccount(); if(!a) return;
        const next = $("#acctStatusSelect").value;
        a.status = next;
        audit("계좌 상태 변경", state.selectedCustomerId, a.no, next);
        toast("상태 변경", `${a.no} → ${next}`, "ok");
        renderAccountSelect(); renderAll();
      });

      // cash
      $("#btnDeposit").addEventListener("click", ()=>{
        addTx("입금", $("#depAmount").value, $("#depMemo").value);
        $("#depAmount").value=""; $("#depMemo").value="";
      });
      $("#btnWithdraw").addEventListener("click", ()=>{
        addTx("출금", $("#wdAmount").value, $("#wdMemo").value);
        $("#wdAmount").value=""; $("#wdMemo").value="";
      });
      $("#btnTransfer").addEventListener("click", ()=>{
        const a = requireAccount(); if(!a) return;
        const toId = $("#toAccountSelect").value;
        const to = db.accounts.find(x=>x.id===toId);
        if(!to){ toast("받는 계좌 없음","다시 선택","bad"); return; }
        const ok = addTx("이체", $("#trAmount").value, $("#trMemo").value, `(→ ${to.no})`);
        if(ok){
          const amt = Number($("#trAmount").value||0);
          to.balance += amt;
          db.transactions.unshift({ id: uid("TX"), at: nowISO(), time: fmtTime(), accountId: to.id, type:"입금", amount: amt, memo:`이체 입금(데모) ← ${a.no}` });
          audit("이체 수취 반영(데모)", to.customerId, to.no, `${money(amt)} ← ${a.no}`);
        }
        $("#trAmount").value=""; $("#trMemo").value="";
        renderAll();
      });

      // receipts
      const receiptFromInputs = (kind)=>{
        const c = currentCustomer(), a = currentAccount();
        if(!a) return;
        const lines = [
          `업무: ${kind}`,
          `계좌: ${a.no}`,
          `고객: ${c?c.name:"—"}`,
          `잔액: ${money(a.balance)}`,
          `비고: 데모 전표(실거래 아님)`,
        ];
        openPrint("거래 영수증(데모)", lines);
      };
      $("#btnReceipt").addEventListener("click", ()=> receiptFromInputs("입금"));
      $("#btnReceipt2").addEventListener("click", ()=> receiptFromInputs("출금"));
      $("#btnReceipt3").addEventListener("click", ()=> receiptFromInputs("이체"));

      // deposit
      $("#btnJoinProduct").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        const amt = Number($("#prodAmount").value||0);
        if(amt<=0){ toast("가입금액 오류","0보다 큰 금액","bad"); return; }
        db.products.unshift({ id: uid("PR"), time: fmtTime(), customerId: c.id, product: $("#prodType").value, amount: amt, status:"정상", memo: $("#prodMemo").value||"" });
        audit("상품 가입 처리", c.id, currentAccount()?.no, `${$("#prodType").value} · ${money(amt)}`);
        toast("상품 가입 완료", `${$("#prodType").value} · ${money(amt)}`, "ok");
        $("#prodAmount").value=""; $("#prodMemo").value="";
        renderLists();
      });
      $("#btnCloseProduct").addEventListener("click", ()=>{
        audit("해지/만기 처리(데모)", state.selectedCustomerId, currentAccount()?.no, $("#maturityAction").value);
        toast("해지/만기(데모)", $("#maturityAction").value, "");
      });
      $("#btnConfirmDoc").addEventListener("click", ()=>{
        const c = currentCustomer();
        openPrint("예적금 가입 확인서(데모)", [
          `상품: ${$("#prodType").value}`,
          `가입금액: ${money($("#prodAmount").value||0)}`,
          `자동이체: ${$("#prodAuto").value||"안 함"}`,
          `만기처리: ${$("#maturityAction").value}`,
          `메모: ${$("#prodMemo").value||"—"}`,
        ]);
        audit("가입 확인서 미리보기", c?.id, currentAccount()?.no, $("#prodType").value);
      });

      // autopay
      $("#btnAutoAdd").addEventListener("click", ()=>{
        const a = requireAccount(); if(!a) return;
        const amt = Number($("#autoAmount").value||0);
        if(amt<=0){ toast("금액 오류","0보다 큰 금액","bad"); return; }
        db.autopays.unshift({ id: uid("AT"), accountId:a.id, status:"활성", type: $("#autoType").value, amount: amt, cycle: $("#autoCycle").value, target: $("#autoTarget").value||"—", memo: $("#autoMemo").value||"" });
        audit("자동 등록", state.selectedCustomerId, a.no, `${$("#autoType").value} · ${money(amt)} · ${$("#autoCycle").value}`);
        toast("자동 등록 완료", `${$("#autoType").value} · ${money(amt)}`, "ok");
        $("#autoAmount").value=""; $("#autoTarget").value=""; $("#autoMemo").value="";
        renderLists();
      });
      $("#btnAutoEdit").addEventListener("click", ()=>{
        audit("자동 변경(데모)", state.selectedCustomerId, currentAccount()?.no, $("#autoType").value);
        toast("변경(데모)", "실제 변경 로직은 다음 단계에서", "");
      });
      $("#btnAutoDel").addEventListener("click", ()=>{
        const a = requireAccount(); if(!a) return;
        const first = db.autopays.find(x=>x.accountId===a.id && x.status==="활성");
        if(!first){ toast("해지할 항목 없음","활성 항목이 없어","bad"); return; }
        first.status="해지";
        audit("자동 해지", state.selectedCustomerId, a.no, `${first.type} · ${money(first.amount)}`);
        toast("해지 완료", first.type, "ok");
        renderLists();
      });
      $("#btnAutoDoc").addEventListener("click", ()=>{
        openPrint("자동이체/납부 확인서(데모)", [
          `유형: ${$("#autoType").value}`,
          `금액: ${money($("#autoAmount").value||0)}`,
          `주기: ${$("#autoCycle").value}`,
          `수취/납부처: ${$("#autoTarget").value||"—"}`,
          `메모: ${$("#autoMemo").value||"—"}`,
        ]);
        audit("자동 확인서 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#autoType").value);
      });

      // bills: pay as withdrawal + record
      $("#btnBillPay").addEventListener("click", ()=>{
        const a = requireAccount(); if(!a) return;
        const amt = Number($("#billAmount").value||0);
        if(amt<=0){ toast("금액 오류","0보다 큰 금액","bad"); return; }
        const ok = addTx("출금", amt, `수납:${$("#billType").value} (${($("#billTo").value||"—")})`);
        if(!ok) return;
        db.bills.unshift({ id: uid("BL"), time: fmtTime(), accountId:a.id, type: $("#billType").value, amount: amt, ref: $("#billRef").value||"—", to: $("#billTo").value||"—" });
        audit("수납 처리", state.selectedCustomerId, a.no, `${$("#billType").value} · ${money(amt)} · ${$("#billRef").value||"—"}`);
        toast("납부 완료", `${$("#billType").value} · ${money(amt)}`, "ok");
        $("#billAmount").value=""; $("#billRef").value=""; $("#billTo").value=""; $("#billMemo").value="";
        renderLists();
      });
      $("#btnBillPrint").addEventListener("click", ()=>{
        openPrint("납부 영수증(데모)", [
          `종류: ${$("#billType").value}`,
          `금액: ${money($("#billAmount").value||0)}`,
          `고지번호: ${$("#billRef").value||"—"}`,
          `납부처: ${$("#billTo").value||"—"}`,
        ]);
        audit("납부 영수증 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#billType").value);
      });

      // reports
      $("#btnRptSubmit").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        db.reports.unshift({ id: uid("RP"), time: fmtTime(), customerId: c.id, type: $("#rptType").value, kyc: $("#kyc").value, memo: $("#rptMemo").value||"", detail: $("#rptDetail").value||"" });
        audit("제신고 처리", c.id, currentAccount()?.no, `${$("#rptType").value} · ${$("#kyc").value}`);
        toast("제신고 처리 완료", $("#rptType").value, "ok");
        $("#rptMemo").value=""; $("#rptDetail").value="";
        renderLists();
      });
      $("#btnRptPrint").addEventListener("click", ()=>{
        openPrint("제신고 확인서(데모)", [
          `업무: ${$("#rptType").value}`,
          `본인확인: ${$("#kyc").value}`,
          `메모: ${$("#rptMemo").value||"—"}`,
          `비고: ${($("#rptDetail").value||"—").slice(0,200)}`,
        ]);
        audit("제신고 확인서 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#rptType").value);
      });

      // security
      $("#btnSecSubmit").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        const v = $("#secLimit").value ? `한도 ${money($("#secLimit").value)}` : "—";
        db.security.unshift({ id: uid("SC"), time: fmtTime(), customerId: c.id, type: $("#secType").value, value: v, memo: $("#secMemo").value||"" });
        audit("보안/한도 처리", c.id, currentAccount()?.no, `${$("#secType").value} · ${v}`);
        toast("처리 완료", $("#secType").value, "ok");
        $("#secLimit").value=""; $("#secMemo").value="";
        renderLists();
      });
      $("#btnSecPrint").addEventListener("click", ()=>{
        openPrint("보안/한도 확인서(데모)", [
          `업무: ${$("#secType").value}`,
          `값: ${$("#secLimit").value ? money($("#secLimit").value) : "—"}`,
          `메모: ${$("#secMemo").value||"—"}`,
        ]);
        audit("보안 확인서 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#secType").value);
      });

      // cards
      $("#btnCardSubmit").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        db.cards.unshift({ id: uid("CD"), time: fmtTime(), customerId: c.id, type: $("#cardType").value, value: $("#cardValue").value||"—", memo: $("#cardMemo").value||"" });
        audit("카드 처리", c.id, currentAccount()?.no, `${$("#cardType").value} · ${$("#cardValue").value||"—"}`);
        toast("카드 처리 완료", $("#cardType").value, "ok");
        $("#cardValue").value=""; $("#cardMemo").value="";
        renderLists();
      });
      $("#btnCardPrint").addEventListener("click", ()=>{
        openPrint("카드 접수증(데모)", [
          `업무: ${$("#cardType").value}`,
          `값: ${$("#cardValue").value||"—"}`,
          `메모: ${$("#cardMemo").value||"—"}`,
        ]);
        audit("카드 접수증 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#cardType").value);
      });

      // misc
      $("#btnMiscSubmit").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        db.misc.unshift({ id: uid("MS"), time: fmtTime(), customerId: c.id, type: $("#miscType").value, value: $("#miscValue").value||"—", memo:"" });
        audit("기타 처리", c.id, currentAccount()?.no, `${$("#miscType").value} · ${$("#miscValue").value||"—"}`);
        toast("처리 완료", $("#miscType").value, "ok");
        $("#miscValue").value="";
        renderLists();
      });
      $("#btnMiscPrint").addEventListener("click", ()=>{
        openPrint("문서 미리보기(데모)", [
          `항목: ${$("#miscType").value}`,
          `값/메모: ${$("#miscValue").value||"—"}`,
        ]);
        audit("문서 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#miscType").value);
      });

      // legal
      $("#btnLegSubmit").addEventListener("click", ()=>{
        const c = currentCustomer(); if(!c){ toast("고객 선택 필요","대시보드에서 고객 선택","bad"); return; }
        db.legal.unshift({ id: uid("LG"), time: fmtTime(), customerId: c.id, type: $("#legType").value, doc: $("#legDoc").value||"—", action: $("#legAction").value, memo: $("#legMemo").value||"" });
        audit("특수 처리", c.id, currentAccount()?.no, `${$("#legType").value} · ${$("#legDoc").value||"—"} · ${$("#legAction").value}`);
        toast("특수 처리 기록", $("#legType").value, "");
        $("#legDoc").value=""; $("#legMemo").value="";
        renderLists();
      });
      $("#btnLegPrint").addEventListener("click", ()=>{
        openPrint("특수 처리 확인서(데모)", [
          `업무: ${$("#legType").value}`,
          `문서번호: ${$("#legDoc").value||"—"}`,
          `조치: ${$("#legAction").value}`,
          `비고: ${($("#legMemo").value||"—").slice(0,200)}`,
        ]);
        audit("특수 확인서 미리보기", state.selectedCustomerId, currentAccount()?.no, $("#legType").value);
      });

      // audit page
      $("#auditFilter").addEventListener("input", renderAudit);
      $("#btnAuditCSV").addEventListener("click", exportAuditCSV);
      $("#btnAuditClear").addEventListener("click", ()=>{
        db.audit = [];
        toast("초기화 완료", "감사로그를 비웠어", "ok");
        audit("감사로그 초기화", state.selectedCustomerId, currentAccount()?.no, "데모 초기화");
      });

      // search
      const gs = $("#globalSearch");
      gs.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(gs.value); });

      // shortcuts
      document.addEventListener("keydown", (e)=>{
        if(e.key==="/" && document.activeElement !== gs){ e.preventDefault(); gs.focus(); }
        if(e.key==="Escape"){ if(picker.open) picker.close(); if($("#userDlg").open) $("#userDlg").close(); if(printDlg.open) printDlg.close(); }
      });

      // picker buttons
      $("#btnClosePicker").addEventListener("click", ()=> picker.close());
      $("#btnPickerOk").addEventListener("click", ()=>{
        if(!pickerSelected.customerId && !pickerSelected.accountId){
          toast("선택이 없어", "원하는 항목을 선택해줘", "bad"); return;
        }
        if(pickerSelected.customerId){
          const c = db.customers.find(x=>x.id===pickerSelected.customerId);
          applySelection({ kind:"customer", id:c.id, customer:c });
        }else{
          const a = db.accounts.find(x=>x.id===pickerSelected.accountId);
          const c = db.customers.find(x=>x.id===a.customerId);
          applySelection({ kind:"account", id:a.id, account:a, customer:c });
        }
        picker.close();
      });

      // user dialog
      const userDlg = $("#userDlg");
      $("#userPill").addEventListener("click", ()=>{
        $("#inpUserName").value = state.user.name;
        $("#inpBranch").value = state.user.branch;
        $("#inpRole").value = state.user.role;
        $("#inpUserNote").value = state.user.note||"";
        userDlg.showModal();
      });
      $("#btnUserClose").addEventListener("click", ()=> userDlg.close());
      $("#btnUserSave").addEventListener("click", ()=>{
        state.user.name = ($("#inpUserName").value||"").trim() || state.user.name;
        state.user.branch = ($("#inpBranch").value||"").trim() || state.user.branch;
        state.user.role = $("#inpRole").value;
        state.user.note = ($("#inpUserNote").value||"").trim();
        renderUser();
        audit("사용자 설정 변경", state.selectedCustomerId, currentAccount()?.no, `${state.user.branch} · ${state.user.role}`);
        toast("저장됨", "사용자 설정 적용", "ok");
        userDlg.close();
      });

      // persistence buttons
      $("#btnSave").addEventListener("click", save);
      $("#btnLoad").addEventListener("click", load);
      $("#btnReset").addEventListener("click", resetAll);
    }

    
    async function bootIdentity(){
      // 로그인 버튼
      const loginBtn = $("#btnTellerLogin");
      const logoutBtn = $("#btnTellerLogout");

      const setBtn = (loggedIn)=>{
        if(!loginBtn || !logoutBtn) return;
        loginBtn.style.display = loggedIn ? "none" : "";
        logoutBtn.style.display = loggedIn ? "" : "none";
      };

      if(!isIdentityReady()){
        setBtn(false);
        toast("Identity 미사용", "Netlify 배포 URL에서 열면 온라인 저장 가능", "warn");
        init();
        return;
      }

      loginBtn?.addEventListener("click", ()=> window.netlifyIdentity.open());
      logoutBtn?.addEventListener("click", ()=> window.netlifyIdentity.logout());

      window.netlifyIdentity.on("init", async (user)=>{
        if(user){
          netlifyUser = user;
          // 현재 로그인 유저를 텔러로 표시(데모)
          state.user.name = user.user_metadata?.full_name || user.email?.split("@")[0] || "Teller";
          state.user.branch = "ONLINE";
          state.user.role = "TELLER";
          setBtn(true);
          try{
            await onlineLoad(true);
          }catch(e){
            toast("온라인 불러오기 실패", e.message, "bad");
          }
          init(true);
        }else{
          netlifyUser = null;
          setBtn(false);
          init(); // 오프라인으로라도 열리게
        }
      });

      window.netlifyIdentity.on("login", async (user)=>{
        window.netlifyIdentity.close();
        netlifyUser = user;
        state.user.name = user.user_metadata?.full_name || user.email?.split("@")[0] || "Teller";
        state.user.branch = "ONLINE";
        state.user.role = "TELLER";
        setBtn(true);
        try{
          await onlineLoad(true);
          toast("로그인 완료", "온라인 데이터 연결됨", "ok");
        }catch(e){
          toast("로그인 됐는데 로드 실패", e.message, "bad");
        }
        init(true);
      });

      window.netlifyIdentity.on("logout", ()=>{
        netlifyUser = null;
        setBtn(false);
        toast("로그아웃", "오프라인 모드로 전환", "warn");
        init(true);
      });

      window.netlifyIdentity.init();
    }


    function init(skipBind=false){
      renderUser();
      renderCustomerSelect();
      renderAccountSelect();
      renderAll();
      renderAudit();
    }

    bind();
    bootIdentity();
  </script>
</body>
</html>
