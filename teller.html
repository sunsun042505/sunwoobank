<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TellerDesk · 선우뱅크</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--card2:#111c33;--text:#e5e7eb;--muted:#94a3b8;--line:rgba(148,163,184,.18);--accent:#22c55e;--danger:#ef4444;--btn:#1f2937}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:linear-gradient(180deg,#060a14,#0b1220 30%,#0b1220);color:var(--text)}
header{position:sticky;top:0;background:rgba(6,10,20,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:36px;height:36px;border-radius:14px;background:linear-gradient(135deg,#60a5fa,#34d399)}
h1{font-size:18px;margin:0}
.small{font-size:12px;color:var(--muted)}
.btn{border:0;background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.ok{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.35)}
.btn.danger{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35)}
.badge{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
.badge.online{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
.badge.offline{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
.grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:14px}
.card{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:14px}
.card h2{font-size:14px;margin:0 0 10px 0}
.hr{height:1px;background:var(--line);margin:10px 0}
.input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(15,23,42,.85);color:var(--text)}
textarea{min-height:80px;resize:vertical}
.nav button{width:100%;text-align:left;margin-bottom:8px}
.note{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{font-size:12px;padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.k{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:12px}
.k .v{font-size:18px;font-weight:800}
.hidden{display:none}
.split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:1050px){.grid{grid-template-columns:1fr}.split{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>TellerDesk</h1>
          <div class="small">창구(텔러) 데모 · 코드 0612 필요 · (실제 금융 서비스 아님)</div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <span id="conn" class="badge offline">OFFLINE</span>
        <span id="sess" class="badge">미로그인</span>
        <button id="logout" class="btn hidden">로그아웃</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>텔러 로그인</h2>
      <div class="note">Netlify 로그인창 안 뜸. 코드(0612)로만 내부 권한 사용.</div>
      <div class="hr"></div>
      <label class="note">코드</label>
      <input id="code" class="input" placeholder="0612" />
      <div style="height:10px"></div>
      <button id="login" class="btn ok" style="width:100%">로그인</button>
      <div id="loginMsg" class="note" style="margin-top:10px"></div>

      <div class="hr"></div>
      <div class="nav">
        <button class="btn" data-tab="dash">대시보드</button>
        <button class="btn" data-tab="cust">고객/계좌</button>
        <button class="btn" data-tab="cash">입금/출금/이체</button>
        <button class="btn" data-tab="jes">제신고(사고/변경)</button>
        <button class="btn" data-tab="enroll">인터넷뱅킹 가입</button>
      </div>

      <div class="hr"></div>
      <div class="note">데이터</div>
      <button id="reload" class="btn" style="width:100%;margin-top:8px">온라인 불러오기</button>
    </div>

    <div class="card">
      <div id="tab-dash">
        <h2>대시보드</h2>
        <div class="note">공용 DB 기준 요약</div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="k"><div class="note">고객</div><div id="kCust" class="v">0</div></div>
          <div class="k"><div class="note">계좌</div><div id="kAcc" class="v">0</div></div>
          <div class="k"><div class="note">제신고</div><div id="kJs" class="v">0</div></div>
        </div>
        <div class="hr"></div>
        <h2>최근 거래</h2>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>시간</th><th>유형</th><th>금액</th><th>메모</th></tr></thead>
            <tbody id="txRows"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-cust" class="hidden">
        <h2>고객 등록</h2>
        <div class="split">
          <div>
            <label class="note">고객명</label>
            <input id="cName" class="input" placeholder="예: 이선우"/>
          </div>
          <div>
            <label class="note">연락처</label>
            <input id="cPhone" class="input" placeholder="예: 010-0000-0000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="note">이메일(선택: 고객로그인 매핑)</label>
        <input id="cEmail" class="input" placeholder="예: sunwoo@example.com"/>
        <div style="height:10px"></div>
        <button id="createCust" class="btn ok">고객 생성</button>
        <div id="custMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>계좌 개설</h2>
        <div class="split">
          <div>
            <label class="note">고객 선택</label>
            <select id="custSel"></select>
          </div>
          <div>
            <label class="note">상품(유형)</label>
            <select id="accType">
              <option>입출금</option>
              <option>정기예금</option>
              <option>정기적금</option>
            </select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">초기잔액</label>
            <input id="initBal" class="input" type="number" placeholder="예: 50000"/>
          </div>
          <div>
            <label class="note">계좌번호(선택)</label>
            <input id="accNo" class="input" placeholder="비우면 자동"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="createAcc" class="btn ok">계좌 개설</button>
        <div id="accMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>목록</h2>
        <div style="overflow:auto;max-height:420px">
          <table>
            <thead><tr><th>고객</th><th>이메일</th><th>계좌</th><th>잔액</th><th>상태/제한</th></tr></thead>
            <tbody id="custTable"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-cash" class="hidden">
        <h2>입금/출금</h2>
        <div class="split">
          <div>
            <label class="note">계좌번호</label>
            <input id="ioAccNo" class="input" placeholder="110-1234-5678"/>
          </div>
          <div>
            <label class="note">구분</label>
            <select id="ioKind">
              <option>입금</option>
              <option>출금</option>
            </select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">금액</label>
            <input id="ioAmt" class="input" type="number" placeholder="예: 10000"/>
          </div>
          <div>
            <label class="note">메모(선택)</label>
            <input id="ioMemo" class="input" placeholder="예: 현금 입금"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="cashBtn" class="btn ok">처리</button>
        <div id="cashMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>이체</h2>
        <div class="split">
          <div>
            <label class="note">출금계좌</label>
            <input id="trFrom" class="input" placeholder="110-0000-0000"/>
          </div>
          <div>
            <label class="note">받는계좌</label>
            <input id="trTo" class="input" placeholder="110-0000-0000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">금액</label>
            <input id="trAmt" class="input" type="number" placeholder="예: 5000"/>
          </div>
          <div>
            <label class="note">메모(선택)</label>
            <input id="trMemo" class="input" placeholder="예: 내부 이체"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="trBtn" class="btn ok">이체 처리</button>
        <div id="trMsg" class="note" style="margin-top:10px"></div>
      </div>

      <div id="tab-jes" class="hidden">
        <h2>제신고(사고/변경) 접수</h2>
        <div class="note">목록 자동 생성 + 압류/가압류/지급정지 포함</div>
        <div class="hr"></div>
        <div class="split">
          <div>
            <label class="note">고객(선택)</label>
            <select id="jsCust"></select>
          </div>
          <div>
            <label class="note">계좌번호(선택)</label>
            <input id="jsAcc" class="input" placeholder="110-1234-5678"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="note">유형</label>
        <select id="jsType">
          <option>주소변경</option>
          <option>연락처변경</option>
          <option>이름변경</option>
          <option>분실신고</option>
          <option>비밀번호오류</option>
          <option>한도변경</option>
          <option>지급정지</option>
          <option>지급정지해제</option>
          <option>압류</option>
          <option>압류해제</option>
          <option>가압류</option>
          <option>가압류해제</option>
        </select>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">상세</label>
            <input id="jsDetail" class="input" placeholder="예: 주소지 변경 접수"/>
          </div>
          <div>
            <label class="note">보류/압류 금액(압류/가압류 선택 시)</label>
            <input id="jsHold" class="input" type="number" placeholder="예: 50000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="note">메모</label>
        <textarea id="jsMemo" placeholder="사유/증빙/처리 메모"></textarea>
        <div style="height:10px"></div>
        <button id="jsCreate" class="btn ok">접수 등록</button>
        <div id="jsMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>제신고 목록</h2>
        <div style="overflow:auto;max-height:420px">
          <table>
            <thead><tr><th>접수시간</th><th>유형</th><th>고객</th><th>계좌</th><th>상태</th><th>처리</th></tr></thead>
            <tbody id="jsRows"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-enroll" class="hidden">
        <h2>인터넷뱅킹 가입</h2>
        <div class="note">Invite-only 상태에서 B 방식(즉시 생성): admin/users로 계정 생성</div>
        <div class="hr"></div>
        <div class="split">
          <div>
            <label class="note">이름</label>
            <input id="eName" class="input" placeholder="예: 이선우"/>
          </div>
          <div>
            <label class="note">이메일</label>
            <input id="eEmail" class="input" placeholder="예: sunwoo@example.com"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="note">임시 비밀번호</label>
        <input id="ePw" class="input" placeholder="예: temp1234"/>
        <div style="height:10px"></div>
        <button id="enrollBtn" class="btn ok">계정 생성 + 고객 매핑</button>
        <div id="enrollMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <div class="note">⚠️ 필요 환경변수: <b>IDENTITY_ADMIN_TOKEN</b> (Netlify Site settings → Environment variables)</div>
      </div>
    </div>
  </div>
</div>

<script>
const conn = document.getElementById('conn');
const sess = document.getElementById('sess');
const loginMsg = document.getElementById('loginMsg');
const logoutBtn = document.getElementById('logout');
const codeInput = document.getElementById('code');

let tellerCode = localStorage.getItem('tellerCode') || "";
let loggedIn = localStorage.getItem('tellerLoggedIn') === "1";
codeInput.value = tellerCode;

function setConn(ok){
  if(ok){
    conn.textContent = 'ONLINE';
    conn.classList.remove('offline'); conn.classList.add('online');
  }else{
    conn.textContent = 'OFFLINE';
    conn.classList.remove('online'); conn.classList.add('offline');
  }
}

async function ping(){
  try{
    const r = await fetch('/.netlify/functions/bank?ping=1', {cache:'no-store'});
    const t = await r.text();
    setConn(r.ok && t.trim()==='pong');
  }catch(e){
    setConn(false);
  }
}
ping();

function money(n){ return (Number(n)||0).toLocaleString('ko-KR') + '원'; }

function setSessionUI(){
  if(loggedIn){
    sess.textContent = 'Teller';
    logoutBtn.classList.remove('hidden');
  }else{
    sess.textContent = '미로그인';
    logoutBtn.classList.add('hidden');
  }
}
setSessionUI();

function requireLogin(){
  if(!loggedIn){
    alert('텔러 로그인 필요(코드 0612)');
    throw new Error('not_logged_in');
  }
}

async function api(action, payload){
  requireLogin();
  const r = await fetch('/.netlify/functions/bank', {
    method:'POST',
    headers:{
      'content-type':'application/json',
      'x-teller-code': tellerCode
    },
    body: JSON.stringify({action, payload})
  });
  const t = await r.text();
  let j; try{ j = JSON.parse(t);}catch{ j = {ok:false, raw:t};}
  if(!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));
  return j;
}

document.getElementById('login').onclick = ()=>{
  tellerCode = (codeInput.value||'').trim();
  localStorage.setItem('tellerCode', tellerCode);
  if(tellerCode !== '0612'){
    loggedIn = false;
    localStorage.setItem('tellerLoggedIn','0');
    loginMsg.textContent = '코드가 틀림. (0612)';
    setSessionUI();
    return;
  }
  loggedIn = true;
  localStorage.setItem('tellerLoggedIn','1');
  loginMsg.textContent = '로그인 완료';
  setSessionUI();
  loadAll();
};

logoutBtn.onclick = ()=>{
  loggedIn = false;
  localStorage.setItem('tellerLoggedIn','0');
  setSessionUI();
};

document.getElementById('reload').onclick = ()=> loadAll();

// Tabs
document.querySelectorAll('.nav button').forEach(b=>{
  b.onclick=()=>{
    const t = b.dataset.tab;
    document.querySelectorAll('[id^="tab-"]').forEach(x=>x.classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
  };
});

function fillSelect(sel, items, labelFn, valueFn){
  sel.innerHTML='';
  items.forEach(it=>{
    const o = document.createElement('option');
    o.value = valueFn(it);
    o.textContent = labelFn(it);
    sel.appendChild(o);
  });
}

function findCustomerName(customers, id){
  const c = customers.find(x=>x.id===id);
  return c ? c.name : id;
}

let cache = { customers:[], accounts:[], jeSingo:[], txs:[] };

function renderDash(){
  document.getElementById('kCust').textContent = cache.customers.length;
  document.getElementById('kAcc').textContent = cache.accounts.length;
  document.getElementById('kJs').textContent = cache.jeSingo.length;
  const txRows = document.getElementById('txRows');
  txRows.innerHTML='';
  cache.txs.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(tx.at).toLocaleString()}</td><td>${tx.kind}</td><td>${money(tx.amount)}</td><td>${tx.memo||''}</td>`;
    txRows.appendChild(tr);
  });
}

function renderLists(){
  const custSel = document.getElementById('custSel');
  const jsCust = document.getElementById('jsCust');

  fillSelect(custSel, cache.customers, c=>`${c.name} (${c.id})`, c=>c.id);
  fillSelect(jsCust, cache.customers, c=>`${c.name} (${c.id})`, c=>c.id);

  // Customer/account table
  const tb = document.getElementById('custTable');
  tb.innerHTML='';
  const custMap = new Map(cache.customers.map(c=>[c.id,c]));
  cache.accounts.forEach(a=>{
    const c = custMap.get(a.customerId);
    const flags = [];
    if(a.flags?.paymentStop) flags.push('지급정지');
    if(a.flags?.seizure) flags.push('압류');
    if(a.flags?.provisionalSeizure) flags.push('가압류');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c?c.name:''} <div class="note">${a.customerId}</div></td>
      <td>${c?.email||''}</td>
      <td><b>${a.accountNo}</b><div class="note">${a.type}</div></td>
      <td>${money(a.balance)}</td>
      <td>${a.status}${flags.length?`<div class="note">${flags.join(' · ')}</div>`:''}</td>`;
    tb.appendChild(tr);
  });

  // JeSingo list
  const jsRows = document.getElementById('jsRows');
  jsRows.innerHTML='';
  cache.jeSingo.forEach(js=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(js.createdAt).toLocaleString()}</td>
      <td><b>${js.type}</b><div class="note">${js.detail||''}</div></td>
      <td>${findCustomerName(cache.customers, js.customerId||'-')}</td>
      <td>${js.accountNo||'-'}</td>
      <td>${js.status||'-'}</td>
      <td>
        <button class="btn" data-id="${js.id}" data-act="처리완료">처리완료</button>
      </td>`;
    jsRows.appendChild(tr);
  });

  jsRows.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      try{
        await api('jeSingo.process', {id: btn.dataset.id, status: '처리완료'});
        await loadAll();
      }catch(e){
        alert('실패: '+e.message);
      }
    };
  });
}

async function loadAll(){
  if(!loggedIn) return;
  try{
    await ping();
    const j = await api('teller.list', {});
    cache = j;
    renderDash();
    renderLists();
  }catch(e){
    setConn(false);
    alert('불러오기 실패: '+e.message);
  }
}

// Actions
document.getElementById('createCust').onclick = async ()=>{
  try{
    const j = await api('teller.createCustomer', {
      name: document.getElementById('cName').value.trim(),
      phone: document.getElementById('cPhone').value.trim(),
      email: document.getElementById('cEmail').value.trim()
    });
    document.getElementById('custMsg').textContent = '생성 완료: ' + j.customer.id;
    await loadAll();
  }catch(e){
    document.getElementById('custMsg').textContent = '실패: ' + e.message;
  }
};

document.getElementById('createAcc').onclick = async ()=>{
  try{
    const j = await api('teller.createAccount', {
      customerId: document.getElementById('custSel').value,
      type: document.getElementById('accType').value,
      initialBalance: Number(document.getElementById('initBal').value||0),
      accountNo: document.getElementById('accNo').value.trim()
    });
    document.getElementById('accMsg').textContent = '개설 완료: ' + j.account.accountNo;
    await loadAll();
  }catch(e){
    document.getElementById('accMsg').textContent = '실패: ' + e.message;
  }
};

document.getElementById('cashBtn').onclick = async ()=>{
  try{
    const j = await api('teller.cashInOut', {
      accountNo: document.getElementById('ioAccNo').value.trim(),
      kind: document.getElementById('ioKind').value,
      amount: Number(document.getElementById('ioAmt').value),
      memo: document.getElementById('ioMemo').value.trim()
    });
    document.getElementById('cashMsg').textContent = '완료: ' + j.tx.id + ' / 잔액 ' + money(j.balance);
    await loadAll();
  }catch(e){
    document.getElementById('cashMsg').textContent = '실패: ' + e.message;
  }
};

document.getElementById('trBtn').onclick = async ()=>{
  try{
    const j = await api('teller.transfer', {
      fromAccountNo: document.getElementById('trFrom').value.trim(),
      toAccountNo: document.getElementById('trTo').value.trim(),
      amount: Number(document.getElementById('trAmt').value),
      memo: document.getElementById('trMemo').value.trim()
    });
    document.getElementById('trMsg').textContent = '이체 완료: ' + j.tx.id;
    await loadAll();
  }catch(e){
    document.getElementById('trMsg').textContent = '실패: ' + e.message;
  }
};

document.getElementById('jsCreate').onclick = async ()=>{
  try{
    const j = await api('jeSingo.create', {
      customerId: document.getElementById('jsCust').value,
      accountNo: document.getElementById('jsAcc').value.trim(),
      type: document.getElementById('jsType').value,
      detail: document.getElementById('jsDetail').value.trim(),
      memo: document.getElementById('jsMemo').value.trim(),
      holdAmount: Number(document.getElementById('jsHold').value||0) || null
    });
    document.getElementById('jsMsg').textContent = '접수 완료: ' + j.jeSingo.id;
    await loadAll();
  }catch(e){
    document.getElementById('jsMsg').textContent = '실패: ' + e.message;
  }
};

document.getElementById('enrollBtn').onclick = async ()=>{
  try{
    const j = await api('admin.enrollIdentity', {
      name: document.getElementById('eName').value.trim(),
      email: document.getElementById('eEmail').value.trim(),
      tempPassword: document.getElementById('ePw').value
    });
    document.getElementById('enrollMsg').textContent = '완료: 고객번호 ' + j.customerId;
    await loadAll();
  }catch(e){
    document.getElementById('enrollMsg').textContent = '실패: ' + e.message;
  }
};
</script>
</body>
</html>
