<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TellerDesk · 선우뱅크 (Supabase)</title>
<style>
:root{--bg:#070b14;--card:rgba(255,255,255,.04);--line:rgba(148,163,184,.18);--text:#e5e7eb;--muted:#94a3b8;--btn:#1f2937}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:linear-gradient(180deg,#050814,#0a1020 30%,#070b14);color:var(--text)}
header{position:sticky;top:0;background:rgba(5,8,20,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
.wrap{max-width:1380px;margin:0 auto;padding:16px}
.row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:38px;height:38px;border-radius:15px;background:linear-gradient(135deg,#60a5fa,#34d399)}
h1{font-size:18px;margin:0}
.small{font-size:12px;color:var(--muted)}
.badge{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
.badge.online{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
.badge.offline{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
.btn{border:0;background:var(--btn);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.ok{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.35)}
.btn.danger{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35)}
.grid{display:grid;grid-template-columns:340px 1fr;gap:14px;margin-top:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
.card h2{font-size:14px;margin:0 0 10px 0}
.hr{height:1px;background:var(--line);margin:10px 0}
.input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(15,23,42,.7);color:var(--text)}
textarea{min-height:90px;resize:vertical}
.note{font-size:12px;color:var(--muted)}
.hidden{display:none !important;}
.nav button{width:100%;text-align:left;margin-bottom:8px}
.topSearch{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.topSearch .input{width:220px}
.results{border:1px solid var(--line);border-radius:14px;background:rgba(15,23,42,.85);overflow:hidden}
.results button{display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;color:var(--text);cursor:pointer;border-bottom:1px solid var(--line)}
.results button:hover{background:rgba(255,255,255,.06)}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.k{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:12px}
.k .v{font-size:18px;font-weight:900}
table{width:100%;border-collapse:collapse}
th,td{font-size:12px;padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
.split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:1100px){.grid{grid-template-columns:1fr}.split{grid-template-columns:1fr}.topSearch .input{width:100%}}

.hidden{display:none !important;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.card2{border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);border-radius:18px;padding:12px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:50}
.modal.hidden{display:none !important}
.modalBox{width:min(920px,100%);max-height:85vh;overflow:auto;background:#0b1224;border:1px solid var(--line);border-radius:16px;padding:16px}
.formRow{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);cursor:pointer;margin-top:8px}
.formRow:hover{background:rgba(255,255,255,.06)}
.sigImg{max-width:100%;border:1px solid var(--line);border-radius:12px;background:#fff}
.pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:var(--text);background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:12px;padding:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>TellerDesk</h1>
          <div class="small">텔러는 코드(0612) 자체 로그인 · 고객은 Supabase 로그인</div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <span id="conn" class="badge offline">OFFLINE</span>
        <span id="sess" class="badge">미로그인</span>
        <button id="logout" class="btn hidden"><span id="tellerNamePill" style="margin-right:10px;opacity:.85">이선우 · 선우은행 의왕지점</span>로그아웃</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>텔러 로그인</h2>
      <div class="note">로그인해야 메뉴/검색/업무 접근 가능</div>
      <div class="hr"></div>
      <label class="note">코드</label>
      <input id="code" class="input" placeholder="0612"/>
      <div style="height:10px"></div>
      <button id="login" class="btn ok" style="width:100%">로그인</button>
      <div id="loginMsg" class="note" style="margin-top:10px"></div>

      <div id="navArea" class="hidden">
        <div class="hr"></div>
        <div class="nav">
          <button class="btn" data-tab="dash">대시보드</button>
          <button class="btn" data-tab="cust">고객등록/계좌</button>
          <button class="btn" data-tab="cash">입출금/이체</button>
          <button class="btn" data-tab="jes">제신고(변경/분실/비번)</button>
          <button class="btn" data-tab="restrict">거래제한/법적조치</button>
          <button class="btn" data-tab="prod">상품가입</button>
          <button class="btn" data-tab="enroll">인터넷뱅킹 가입</button>
        </div>
        <div class="hr"></div>
        <button id="refresh" class="btn" style="width:100%">선택 고객 새로고침</button>
        <div class="note" style="margin-top:10px">⚠️ "식별번호(13자리)"는 데모용 가짜 숫자만. 실제 주민등록번호 입력 금지.</div>
      </div>
    </div>

    <div class="card">
      <div id="topArea" class="hidden">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <div class="note">고객 검색(이름/전화/이메일) → 선택 후 업무 처리</div>
            <div class="topSearch" style="margin-top:8px">
              <input id="sName" class="input" placeholder="이름"/>
              <input id="sPhone" class="input" placeholder="전화번호"/>
              <input id="sEmail" class="input" placeholder="이메일"/>
              <button id="sBtn" class="btn">검색</button>
            </div>
            <div id="resBox" class="results hidden" style="margin-top:10px"></div>
          </div>
          <div style="min-width:320px">
            <div class="note">선택 고객</div>
            <div class="badge" id="selInfo" style="margin-top:8px;width:100%;display:block">없음</div>
            <div style="height:10px"></div>
            
          <div style="height:10px"></div>
          <div class="note">서식 신청자</div>
          <select id="qrApplicant" class="input">
            <option value="self">본인</option>
            <option value="agent">대리인</option>
          </select>
          <div class="note" style="margin-top:6px">대리인 선택 시 서식에서 대리인 정보/서명 입력</div>
          <div style="height:10px"></div>
<button id="openFormQR" class="btn ok" style="width:100%">아이패드 서식 QR 열기(10분)</button>
<div style="height:10px"></div>
<button id="openForms" class="btn" style="width:100%">작성된 서식 보기</button>
<div id="formsPanel" class="card hidden" style="margin-top:10px;padding:12px">
  <div class="row" style="justify-content:space-between;gap:10px">
    <div class="note">작성된 서식</div>
    <button id="formsRefresh" class="btn">조회</button>
  </div>
  <div class="note" style="margin-top:6px">고객 선택 후 조회하면 최근 제출된 서식이 보여요.</div>
  <div id="formsList" style="margin-top:10px"></div>
</div>

            <div class="note" style="margin-top:8px">고객 선택 후 눌러서 QR을 아이패드로 스캔</div>
          </div>
        </div>
        <div class="hr"></div>
      </div>

      <div id="tab-dash">
        <h2>대시보드</h2>
        <div class="note">선택 고객이 있으면 고객 기준 요약</div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="k"><div class="note">선택 고객</div><div id="kCust" class="v">-</div></div>
          <div class="k"><div class="note">계좌</div><div id="kAcc" class="v">-</div></div>
          <div class="k"><div class="note">제신고</div><div id="kJs" class="v">-</div></div>
          <div class="k"><div class="note">잔액합</div><div id="kBal" class="v">-</div></div>
        </div>
        <div class="hr"></div>
        <h2>선택 고객 계좌</h2>
        <div class="note" id="dashHint">고객을 선택해줘.</div>
        <div style="overflow:auto;max-height:420px;margin-top:10px">
          <table>
            <thead><tr><th>계좌</th><th>유형</th><th>상태</th><th>제한</th><th>잔액</th></tr></thead>
            <tbody id="accRows"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-cust" class="hidden">
        <h2>고객 등록</h2>
        <div class="split">
          <div>
            <label class="note">이름</label>
            <input id="cName" class="input" placeholder="예: 이선우"/>
          </div>
          <div>
            <label class="note">식별번호(13자리, 데모용 가짜 숫자)</label>
            <input id="cRRN" class="input" placeholder="예: 0000000000000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">전화번호</label>
            <input id="cPhone" class="input" placeholder="010-0000-0000"/>
          </div>
          <div>
            <label class="note">이메일(선택)</label>
            <input id="cEmail" class="input" placeholder="you@example.com"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="note">주소</label>
        <input id="cAddr" class="input" placeholder="예: 부산 ..."/>
        <div style="height:10px"></div>
        <button id="cCreate" class="btn ok">고객 생성</button>
        <div id="cMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>계좌 개설(선택 고객)</h2>
        <div class="note">고객을 먼저 검색해서 선택해줘.</div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">상품</label>
            <select id="aType">
              <option>입출금</option>
              <option>정기예금</option>
              <option>정기적금</option>
            </select>
          </div>
          <div>
            <label class="note">초기잔액</label>
            <input id="aBal" class="input" type="number" placeholder="50000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">계좌번호(선택)</label>
            <input id="aNo" class="input" placeholder="비우면 자동"/>
          </div>
          <div>
            <label class="note">계좌 비밀번호(핀 4자리 이상)</label>
            <input id="aPin" class="input" placeholder="예: 1234"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="aCreate" class="btn ok">계좌 개설</button>
        <div id="aMsg" class="note" style="margin-top:10px"></div>
      </div>

      <div id="tab-cash" class="hidden">
        <h2>입금/출금</h2>
        <div class="split">
          <div>
            <label class="note">계좌 선택</label>
            <select id="ioAcc"></select>
          </div>
          <div>
            <label class="note">구분</label>
            <select id="ioKind">
              <option>입금</option>
              <option>출금</option>
            </select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">금액</label>
            <input id="ioAmt" class="input" type="number" placeholder="10000"/>
          </div>
          <div>
            <label class="note">메모</label>
            <input id="ioMemo" class="input" placeholder="현금 입금"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="ioBtn" class="btn ok">처리</button>
        <div id="ioMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>이체</h2>
        <div class="split">
          <div>
            <label class="note">출금계좌</label>
            <select id="trFrom"></select>
          </div>
          <div>
            <label class="note">받는계좌번호</label>
            <input id="trTo" class="input" placeholder="110-1234-5678"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">금액</label>
            <input id="trAmt" class="input" type="number" placeholder="5000"/>
          </div>
          <div>
            <label class="note">메모</label>
            <input id="trMemo" class="input" placeholder="업무 이체"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="trBtn" class="btn ok">이체 처리</button>
        <div id="trMsg" class="note" style="margin-top:10px"></div>
      </div>

      <div id="tab-jes" class="hidden">
        <h2>제신고(변경/분실/비밀번호)</h2>
        <div class="note">지급정지/압류/가압류는 '거래제한/법적조치' 메뉴에서 처리</div>
        <div class="hr"></div>

        <label class="note">분류</label>
        <select id="jsCat">
          <option>비밀번호변경</option>
          <option>정보변경</option>
          <option>분실신고</option>
          <option>기타</option>
        </select>
        <div style="height:10px"></div>

        <div id="jsPwBox" class="hidden">
          <div class="split">
            <div>
              <label class="note">계좌 선택</label>
              <select id="jsAcc"></select>
            </div>
            <div>
              <label class="note">현재 계좌비밀번호(알면 입력)</label>
              <input id="jsOldPin" class="input" placeholder="예: 1234"/>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="split">
            <div>
              <label class="note">새 계좌비밀번호</label>
              <input id="jsNewPin" class="input" placeholder="예: 5678"/>
            </div>
            <div>
              <label class="note">확인</label>
              <input id="jsNewPin2" class="input" placeholder="다시 입력"/>
            </div>
          </div>
        </div>

        <div id="jsInfoBox" class="hidden">
          <div class="split">
            <div>
              <label class="note">변경 항목</label>
              <select id="jsField">
                <option>주소</option>
                <option>연락처</option>
                <option>이메일</option>
                <option>이름</option>
              </select>
            </div>
            <div>
              <label class="note">새 값</label>
              <input id="jsNewVal" class="input" placeholder="변경할 값"/>
            </div>
          </div>
        </div>

        <div id="jsLostBox" class="hidden">
          <label class="note">분실 항목</label>
          <select id="jsItem">
            <option>카드</option>
            <option>통장</option>
            <option>OTP</option>
            <option>도장</option>
            <option>휴대폰</option>
            <option>기타</option>
          </select>
        </div>

        <div style="height:10px"></div>
        <label class="note">상세/메모</label>
        <textarea id="jsDetail" placeholder="증빙/사유/처리 메모"></textarea>
        <div style="height:10px"></div>
        <button id="jsBtn" class="btn ok">접수 등록</button>
        <div id="jsMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>제신고 목록(선택 고객)</h2>
        <div style="overflow:auto;max-height:420px">
          <table>
            <thead><tr><th>시간</th><th>분류</th><th>내용</th><th>상태</th><th>처리</th></tr></thead>
            <tbody id="jsRows"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-restrict" class="hidden">
        <h2>거래제한 / 법적조치</h2>
        <div class="note">지급정지 · 압류 · 가압류 · 한도계좌 해제</div>
        <div class="hr"></div>

        <label class="note">계좌 선택</label>
        <select id="rAcc"></select>
        <div style="height:10px"></div>

        <div class="split">
          <div>
            <label class="note">지급정지</label>
            <select id="rPay">
              <option value="on">ON</option>
              <option value="off">OFF</option>
            </select>
          </div>
          <div>
            <label class="note">한도계좌</label>
            <select id="rLimit">
              <option value="on">ON</option>
              <option value="off">OFF(해제)</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">압류</label>
            <select id="rSeiz">
              <option value="on">ON</option>
              <option value="off">OFF</option>
            </select>
          </div>
          <div>
            <label class="note">가압류</label>
            <select id="rProv">
              <option value="on">ON</option>
              <option value="off">OFF</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <label class="note">압류/가압류 보류금액(선택)</label>
        <input id="rHold" class="input" type="number" placeholder="예: 50000"/>
        <div style="height:10px"></div>
        <button id="rApply" class="btn ok">적용</button>
        <button id="rReleaseLimit" class="btn" style="margin-left:8px">한도계좌 해제(버튼)</button>
        <div id="rMsg" class="note" style="margin-top:10px"></div>

        <div class="hr"></div>
        <h2>상태 미리보기(선택 계좌)</h2>
        <div id="rPreview" class="badge" style="display:block;width:100%">-</div>
      </div>

      
      <div id="tab-prod" class="hidden">
        <h2>상품가입</h2>
        <div class="note">선택 고객 기준으로 상품 가입을 처리해. (예적금/대출/투자/카드/보험)</div>
        <div class="hr"></div>
        <div id="prodBox"></div>
        <div id="prodMsg" class="note" style="margin-top:10px"></div>
      </div>

<div id="tab-enroll" class="hidden">
        <h2>인터넷뱅킹 가입(계정 생성, invite-only)</h2>
        <div class="note">Supabase Auth 계정 생성 + email_confirm 자동 true</div>
        <div class="hr"></div>

        <div class="split">
          <div>
            <label class="note">이름</label>
            <input id="eName" class="input" placeholder="이선우"/>
          </div>
          <div>
            <label class="note">이메일</label>
            <input id="eEmail" class="input" placeholder="you@example.com"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="split">
          <div>
            <label class="note">임시 비밀번호</label>
            <input id="ePw" class="input" placeholder="temp1234"/>
          </div>
          <div>
            <label class="note">전화(선택)</label>
            <input id="ePhone" class="input" placeholder="010-0000-0000"/>
          </div>
        </div>
        <div style="height:10px"></div>
        <button id="eBtn" class="btn ok">계정 생성 + 고객 매핑</button>
        <div id="eMsg" class="note" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>


<div id="qrModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50;padding:18px">
  <div style="width:min(560px,95vw);background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);border-radius:20px;padding:14px">
    <div class="row">
      <div>
        <div style="font-weight:900">아이패드로 스캔</div>
        <div class="note">토큰 유효시간 10분 · 제출하면 자동 만료</div>
      </div>
      <button id="qrClose" class="btn2">닫기</button>
    </div>
    <div class="hr"></div>
    <div class="row" style="justify-content:center">
      <div id="qrBox" style="background:#fff;padding:14px;border-radius:16px"></div>
    </div>
    <div class="hr"></div>
    <div class="note" id="qrLink" style="word-break:break-all"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// XSS-safe text
function escapeHtml(input){
  const s = String(input ?? "");
  return s.replace(/[&<>"']/g, (ch) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[ch]));
}
// ---------- 상품가입 ----------
function renderProducts(){
  const box = document.getElementById('prodBox');
  const msg = document.getElementById('prodMsg');
  if(!box) return;
  if(msg) msg.textContent = '';

  const cust = selectedCustomer || null;
  const accList = (selectedDetail && selectedDetail.accounts) ? selectedDetail.accounts : [];
  const firstAcc = accList[0] ? accList[0].account_no : '';

  box.innerHTML = `
    <div class="grid2">
      <div class="card2">
        <div style="font-weight:900;margin-bottom:8px">대상 고객</div>
        ${cust ? `
          <div class="note">선택 고객이 자동 적용됨</div>
          <div style="margin-top:8px" class="note">
            <b>${escapeHtml(cust.name)}</b> · ${escapeHtml(cust.phone||'-')} · ${escapeHtml(cust.email||'-')}
          </div>
        ` : `
          <div class="note">고객을 선택하지 않아도 가입 가능. 아래 정보로 신규 고객 생성 후 처리됨.</div>
          <div style="height:10px"></div>
          <div class="row">
            <div style="flex:1">
              <div class="note">이름</div>
              <input id="pCustName" class="input" placeholder="예: 이선우" />
            </div>
            <div style="flex:1">
              <div class="note">전화번호</div>
              <input id="pCustPhone" class="input" placeholder="예: 010-0000-0000" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <div style="flex:1">
              <div class="note">이메일</div>
              <input id="pCustEmail" class="input" placeholder="you@example.com" />
            </div>
            <div style="flex:1">
              <div class="note">식별번호(13자리, 데모)</div>
              <input id="pCustRRN" class="input" inputmode="numeric" placeholder="예: 9001011234567" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="note">⚠️ 실제 주민등록번호 입력 금지. 데모용 가짜 숫자만.</div>
        `}
        <div style="height:12px"></div>
        <div class="note">연동 계좌(선택)</div>
        <div class="row">
          <input id="pAccountNo" class="input" style="flex:1" value="${escapeHtml(firstAcc||'')}" placeholder="계좌번호 (비우면 미연동)" />
          <label style="display:flex;align-items:center;gap:8px;white-space:nowrap">
            <input id="pAutoCreateAcc" type="checkbox" ${cust && firstAcc ? '' : 'checked'} />
            <span class="note">계좌 자동생성</span>
          </label>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <input id="pAccPin" class="input" style="flex:1" placeholder="계좌 비밀번호(4자리+ · 자동생성 시 필요)" inputmode="numeric" />
          <input id="pAccInit" class="input" style="flex:1" placeholder="초기 잔액(원 · 선택)" type="number" min="0" />
        </div>
      </div>

      <div class="card2">
        <div style="font-weight:900;margin-bottom:8px">상품 가입</div>
        <div class="row">
          <div style="flex:1">
            <div class="note">카테고리</div>
            <select id="prodCategory" class="input">
              <option>예적금</option>
              <option>대출</option>
              <option>투자</option>
              <option>카드</option>
              <option>보험</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="note">세부 상품</div>
            <select id="pType" class="input"></select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div id="pFields"></div>
        <div style="height:10px"></div>
        <button id="pApply" class="btn ok" style="width:100%">가입 처리</button>
        <div class="note" id="pHint" style="margin-top:10px;opacity:.9"></div>
      </div>
    </div>
  `;

  const categorySel = document.getElementById('prodCategory');
  const typeSel = document.getElementById('pType');
  const fields = document.getElementById('pFields');
  const applyBtn = document.getElementById('pApply');
  const hint = document.getElementById('pHint');

  function setTypeOptions(){
    if(!categorySel || !typeSel) return;
    const c = categorySel.value;
    const opts = [];
    if(c==='예적금'){ opts.push('정기적금','자유적금','주택청약'); }
    if(c==='대출'){ opts.push('일반대출'); }
    if(c==='투자'){ opts.push('펀드'); }
    if(c==='카드'){ opts.push('체크카드','신용카드'); }
    if(c==='보험'){ opts.push('보험'); }
    typeSel.innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
    renderFields();
  }

  function renderFields(){
    if(!fields || !categorySel || !typeSel) return;
    const c = categorySel.value;
    const t = typeSel.value;

    if(c==='예적금'){
      fields.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div class="note">가입 금액(원)</div>
            <input id="pAmount" class="input" type="number" min="0" placeholder="예: 100000" />
          </div>
          <div style="flex:1">
            <div class="note">기간(개월)</div>
            <input id="pTerm" class="input" type="number" min="1" placeholder="예: 12" />
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="note">주택청약 선택 시 만기는 자동으로 9999년으로 처리됨</div>
      `;
      if(hint) hint.textContent = '예적금: 금액/기간 입력 후 가입 처리.';
      return;
    }

    if(c==='대출'){
      fields.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div class="note">대출 금액(원)</div>
            <input id="pLoanAmt" class="input" type="number" min="0" placeholder="예: 5000000" />
          </div>
          <div style="flex:1">
            <div class="note">이자율</div>
            <input class="input" value="고정 4%" disabled />
          </div>
        </div>
      `;
      if(hint) hint.textContent = '대출: 금액 입력. 이자율은 고정 4%.';
      return;
    }

    if(c==='투자'){
      fields.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div class="note">펀드 상품명</div>
            <input id="pFundName" class="input" placeholder="예: 선우 성장형 펀드" />
          </div>
          <div style="flex:1">
            <div class="note">투자 금액(원)</div>
            <input id="pFundAmt" class="input" type="number" min="0" placeholder="예: 200000" />
          </div>
        </div>
      `;
      if(hint) hint.textContent = '투자: 펀드 상품 + 금액 입력.';
      return;
    }

    if(c==='카드'){
      fields.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div class="note">카드 종류</div>
            <select id="pCardType" class="input">
              <option>체크카드</option>
              <option>신용카드</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="note">카드 비밀번호</div>
            <input id="pCardPin" class="input" inputmode="numeric" placeholder="예: 1234" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div id="pCreditBlock" class="card2" style="padding:12px;border:1px solid rgba(255,255,255,.06)">
          <div style="font-weight:900;margin-bottom:6px">신용카드 옵션</div>
          <div class="row">
            <div style="flex:1">
              <div class="note">한도(원)</div>
              <input id="pCreditLimit" class="input" type="number" min="0" placeholder="예: 3000000" />
            </div>
            <div style="flex:1">
              <div class="note">신용정보 동의</div>
              <button id="pAgree" class="btn2" style="width:100%">동의 버튼</button>
              <div class="note" id="pAgreeState" style="margin-top:6px;opacity:.9">미동의</div>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <div style="flex:1">
              <div class="note">해외겸용/국내전용</div>
              <select id="pNetworkType" class="input">
                <option value="DOMESTIC">국내전용</option>
                <option value="INTL">해외겸용</option>
              </select>
            </div>
            <div style="flex:1">
              <div class="note">브랜드(해외겸용)</div>
              <select id="pNetworkBrand" class="input">
                <option value="VISA">VISA</option>
                <option value="MASTER">MASTER</option>
              </select>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="note">배송지</div>
          <input id="pShip" class="input" placeholder="예: 경기 의왕시 ..." />
        </div>
      `;
      const cardTypeSel = document.getElementById('pCardType');
      const creditBlock = document.getElementById('pCreditBlock');
      function toggleCredit(){
        const isCredit = cardTypeSel && cardTypeSel.value==='신용카드';
        if(creditBlock) creditBlock.style.display = isCredit ? 'block' : 'none';
      }
      if(cardTypeSel) cardTypeSel.onchange = toggleCredit;
      toggleCredit();

      const agreeBtn = document.getElementById('pAgree');
      if(agreeBtn){
        window.__creditAgree = false;
        agreeBtn.onclick = ()=>{ window.__creditAgree = true; document.getElementById('pAgreeState').textContent='동의 완료'; };
      }
      if(hint) hint.textContent = '카드: 국내전용 BIN 9496 / VISA 4816 / MASTER 5927로 발급.';
      return;
    }

    if(c==='보험'){
      fields.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div class="note">보험 상품명</div>
            <input id="pInsName" class="input" placeholder="예: 선우 안심보험" />
          </div>
          <div style="flex:1">
            <div class="note">월 보험료(원)</div>
            <input id="pInsPremium" class="input" type="number" min="0" placeholder="예: 25000" />
          </div>
        </div>
      `;
      if(hint) hint.textContent = '보험: 상품명/보험료 입력.';
      return;
    }
  }

  async function ensureCustomer(){
    if(selectedCustomer) return selectedCustomer.id;
    const name = (document.getElementById('pCustName')?.value||'').trim();
    const phone = (document.getElementById('pCustPhone')?.value||'').trim();
    const email = (document.getElementById('pCustEmail')?.value||'').trim();
    const rrn = (document.getElementById('pCustRRN')?.value||'').replace(/[^0-9]/g,'');
    if(!name) throw new Error('이름 입력');
    if(rrn.length!==13) throw new Error('식별번호 13자리(데모) 입력');
    const j = await api('teller.createCustomer', { name, rrn, phone, email, address: '' });
    // select it in UI
    selectedCustomer = j.customer;
    await refreshSelected();
    return j.customer.id;
  }

  async function ensureAccount(customerId){
    const auto = document.getElementById('pAutoCreateAcc')?.checked;
    const accNoInput = (document.getElementById('pAccountNo')?.value||'').trim();
    if(accNoInput) return accNoInput;

    if(!auto) return null;

    const pin = (document.getElementById('pAccPin')?.value||'').trim();
    if(pin.length<4) throw new Error('계좌 자동생성: 계좌 비밀번호 4자리+ 입력');
    const init = Number(document.getElementById('pAccInit')?.value||0);
    const j = await api('teller.createAccount', { customerId, type: '입출금', initialBalance: init, accountPin: pin });
    await refreshSelected();
    return j.account.account_no;
  }

  if(categorySel) categorySel.onchange = setTypeOptions;
  if(typeSel) typeSel.onchange = renderFields;
  setTypeOptions();

  if(applyBtn){
    applyBtn.onclick = async ()=>{
      try{
        if(msg) msg.textContent = '';
        const customerId = await ensureCustomer();
        const accountNo = await ensureAccount(customerId);

        const c = categorySel.value;
        const t = typeSel.value;

        let data = {};
        if(c==='예적금'){
          const amount = Number(document.getElementById('pAmount')?.value||0);
          let term = Number(document.getElementById('pTerm')?.value||0);
          if(amount<=0) throw new Error('가입 금액 입력');
          if(term<=0) throw new Error('기간(개월) 입력');
          // 주택청약: 만기 9999년 표기 (데모)
          const isHousing = t==='주택청약';
          data = { amount, termMonths: term, maturityYear: isHousing ? 9999 : null };
        } else if(c==='대출'){
          const loanAmt = Number(document.getElementById('pLoanAmt')?.value||0);
          if(loanAmt<=0) throw new Error('대출 금액 입력');
          data = { amount: loanAmt, interestRate: 0.04, interestType: '고정(4%)' };
        } else if(c==='투자'){
          const name = (document.getElementById('pFundName')?.value||'').trim();
          const amt = Number(document.getElementById('pFundAmt')?.value||0);
          if(!name) throw new Error('펀드 상품명 입력');
          if(amt<=0) throw new Error('투자 금액 입력');
          data = { fundName: name, amount: amt };
        } else if(c==='카드'){
          const cardType = (document.getElementById('pCardType')?.value||'체크카드');
          const pin = (document.getElementById('pCardPin')?.value||'').trim();
          if(pin.length<4) throw new Error('카드 비밀번호 4자리+ 입력');

          let network = 'DOMESTIC';
          let creditLimit = null;
          let shippingAddress = (document.getElementById('pShip')?.value||'').trim();
          if(cardType==='신용카드'){
            if(!window.__creditAgree) throw new Error('신용정보 동의 버튼을 눌러줘');
            creditLimit = Number(document.getElementById('pCreditLimit')?.value||0);
            if(creditLimit<=0) throw new Error('신용한도 입력');
            const nt = document.getElementById('pNetworkType')?.value||'DOMESTIC';
            if(nt==='INTL'){
              const brand = document.getElementById('pNetworkBrand')?.value||'VISA';
              network = brand; // VISA or MASTER
            } else {
              network = 'DOMESTIC';
            }
          }
          data = { cardType, network, creditLimit, pin, shippingAddress };
        } else if(c==='보험'){
          const name = (document.getElementById('pInsName')?.value||'').trim();
          const premium = Number(document.getElementById('pInsPremium')?.value||0);
          if(!name) throw new Error('보험 상품명 입력');
          if(premium<=0) throw new Error('보험료 입력');
          data = { insuranceName: name, premium };
        }

        const res = await api('teller.product.apply', {
          customerId,
          accountNo,
          category: c,
          productType: t,
          data
        });

        if(res.card && res.card.card_number){
          if(msg) msg.textContent = `완료! 카드번호: ${res.card.card_number} (${res.card.network})`;
        }else{
          if(msg) msg.textContent = '완료! 신청이 저장됨.';
        }
      }catch(e){
        if(msg) msg.textContent = '실패: ' + (e.message || e);
      }
    };
  }
}


function int(v){ const n=Number(v||0); return Number.isFinite(n)?Math.floor(n):0; }
</script>
<script>
const conn = document.getElementById('conn');
const sess = document.getElementById('sess');
const loginMsg = document.getElementById('loginMsg');
const logoutBtn = document.getElementById('logout');
const navArea = document.getElementById('navArea');

// ---------- Tabs ----------
const TABS = ['dash','cust','cash','jes','restrict','prod','enroll'];
function showTab(tab){
  TABS.forEach(t=>{
    const el=document.getElementById('tab-'+t);
    if(el) el.classList.add('hidden');
  });
  const target=document.getElementById('tab-'+tab);
  if(target) target.classList.remove('hidden');

  // highlight button
  document.querySelectorAll('.nav .btn[data-tab]').forEach(b=>{
    if(b.dataset.tab===tab) b.classList.add('active');
    else b.classList.remove('active');
  });

  if(tab==='prod') renderProducts();
}

document.querySelectorAll('.nav .btn[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=> showTab(btn.dataset.tab));
});

const topArea = document.getElementById('topArea');
const selInfo = document.getElementById('selInfo');
const resBox = document.getElementById('resBox');

let tellerCode = localStorage.getItem('tellerCode') || "";
let loggedIn = localStorage.getItem('tellerLoggedIn') === "1";
document.getElementById('code').value = tellerCode;

let selectedCustomer = null;
let selectedDetail = null;

function setConn(ok){
  conn.textContent = ok ? 'ONLINE' : 'OFFLINE';
  conn.classList.toggle('online', ok);
  conn.classList.toggle('offline', !ok);
}
async function ping(){
  try{
    const r = await fetch('/.netlify/functions/bank?ping=1', { cache:'no-store' });
    const t = await r.text();
    setConn(r.ok && t.trim()==='pong');
  }catch(e){ setConn(false); }
}
ping();

function setSessionUI(){
  if(loggedIn){
    sess.textContent = 'Teller';
    logoutBtn.classList.remove('hidden');
    navArea.classList.remove('hidden');
    topArea.classList.remove('hidden');
  }else{
    sess.textContent = '미로그인';
    logoutBtn.classList.add('hidden');
    navArea.classList.add('hidden');
    topArea.classList.add('hidden');
    selectedCustomer = null;
    selectedDetail = null;
    selInfo.textContent = '없음';
  }
}
setSessionUI();

function requireLogin(){
  if(!loggedIn){
    alert('텔러 로그인 필요(코드 0612)');
    throw new Error('not_logged_in');
  }
}

async function api(action, payload){
  requireLogin();
  const r = await fetch('/.netlify/functions/bank', {
    method:'POST',
    headers:{ 'content-type':'application/json', 'x-teller-code': tellerCode },
    body: JSON.stringify({ action, payload })
  });
  const j = await r.json().catch(()=>({ok:false,error:'bad_json'}));
  if(!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));
  return j;
}
// ---------- QR (iPad 서식) ----------
if(!window.__SUNWOO_QR_INIT__){ window.__SUNWOO_QR_INIT__ = true;
const qrModal = document.getElementById('qrModal');
const qrClose = document.getElementById('qrClose');
const qrBox = document.getElementById('qrBox');
const qrLink = document.getElementById('qrLink');

// force hidden on load (inline style can override css)
if(qrModal){ qrModal.classList.add('hidden'); qrModal.style.display='none'; }


function openQR(){ if(qrModal){ qrModal.style.display='flex'; qrModal.classList.remove('hidden'); } }
function closeQR(){
  if(qrModal){ qrModal.classList.add('hidden'); qrModal.style.display='none'; }
  if(qrBox) qrBox.innerHTML='';
  if(qrLink) qrLink.textContent='';
}
if(qrClose) qrClose.onclick = closeQR;
if(qrModal) qrModal.addEventListener('click', (e)=>{ if(e.target===qrModal) closeQR(); });

const openFormBtn = document.getElementById('openFormQR');
if(openFormBtn){
  openFormBtn.onclick = async ()=>{
    try{
      if(!selectedCustomer) throw new Error('고객 선택 필요');
      openQR();
      // optional account: first account
      const accList = (selectedDetail && selectedDetail.accounts) ? selectedDetail.accounts : [];
      const firstAcc = accList[0] ? accList[0].account_no : null;

      if(qrBox) qrBox.innerHTML = '<div class="note">QR 생성 중…</div>';
      const j = await api('form.createToken', { customerId: selectedCustomer.id, accountNo: firstAcc, formType: '창구 서식' });
      const fullUrlBase = location.origin + j.url;
        const applicant = (document.getElementById('qrApplicant')?.value || 'self').trim();
        const fullUrl = fullUrlBase + (fullUrlBase.includes('?') ? '&' : '?') + 'applicant=' + encodeURIComponent(applicant);
      if(qrLink) qrLink.textContent = fullUrl;

      // Use image-based QR for reliability (no external JS lib)
      const imgUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=' + encodeURIComponent(fullUrl);
      if(qrBox) qrBox.innerHTML = `<img alt="QR" src="${imgUrl}" style="width:320px;height:320px;display:block;border-radius:12px"/>`;
    }catch(e){
      closeQR();
      alert('QR 생성 실패: ' + (e.message || e));
    }
  };
}


// ---------- 상품가입 ----------

const prodCategory = document.getElementById('prodCategory');
const prodType = document.getElementById('prodType');
const prodFields = document.getElementById('prodFields');
const prodApply = document.getElementById('prodApply');
const prodMsg = document.getElementById('prodMsg');

function setTypeOptions(){
  if(!prodCategory || !prodType) return;
  const c = prodCategory.value;
  const opts = [];
  if(c==='예적금'){ opts.push('정기적금','자유적금','주택청약'); }
  if(c==='대출'){ opts.push('일반대출'); }
  if(c==='투자'){ opts.push('펀드'); }
  if(c==='카드'){ opts.push('신용카드','체크카드'); }
  if(c==='보험'){ opts.push('보험'); }
  prodType.innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
  renderFields();
}

function field(html){ return `<div style="margin-top:10px">${html}</div>`; }

function renderFields(){
  if(!prodFields) return;
  const c = prodCategory.value;
  const t = prodType.value;
  let html = `<div class="note">입력값</div>`;
  if(c==='예적금'){
    html += field(`<label class="note">가입 금액(원)</label><input id="pAmount" class="input" type="number" min="0" placeholder="예: 100000">`);
    if(t==='주택청약'){
      html += field(`<label class="note">기간(년)</label><input id="pTerm" class="input" type="number" value="9999" disabled>`);
      html += `<div class="note" style="margin-top:8px">주택청약은 만기 연도를 9999년으로 고정했어.</div>`;
    }else{
      html += field(`<label class="note">기간(개월)</label><input id="pTerm" class="input" type="number" min="1" placeholder="예: 12">`);
    }
  } else if(c==='대출'){
    html += field(`<label class="note">대출 금액(원)</label><input id="pLoanAmount" class="input" type="number" min="0" placeholder="예: 1000000">`);
    html += `<div class="note" style="margin-top:8px">이자: 고정 4%</div>`;
  } else if(c==='투자'){
    html += field(`<label class="note">펀드 상품명</label><input id="pFundName" class="input" placeholder="예: 선우성장펀드">`);
    html += field(`<label class="note">투자 금액(원)</label><input id="pFundAmount" class="input" type="number" min="0" placeholder="예: 500000">`);
  } else if(c==='카드'){
    if(t==='신용카드'){
      html += field(`<label class="note">한도(원)</label><input id="pCreditLimit" class="input" type="number" min="0" placeholder="예: 1000000">`);
      html += field(`<button id="pCreditAgree" class="btn2" type="button">신용정보 동의</button> <span id="pAgreeState" class="note" style="margin-left:8px">미동의</span>`);
    } else {
      html += `<div class="note" style="margin-top:8px">체크카드는 한도/동의 없음</div>`;
    }
    html += field(`<label class="note">국내전용 / 해외겸용</label>
      <select id="pNetwork" class="input">
        <option value="DOMESTIC">국내전용</option>
        <option value="FOREIGN">해외겸용</option>
      </select>`);
    html += field(`<div id="pForeignBox" class="hidden">
      <label class="note">브랜드 선택</label>
      <select id="pBrand" class="input">
        <option value="VISA">VISA</option>
        <option value="MASTER">MASTER</option>
      </select>
      <div class="note" style="margin-top:6px">VISA: 4816… / MASTER: 5927…</div>
    </div>`);
    html += field(`<label class="note">카드 배송지</label><input id="pShip" class="input" placeholder="예: 서울시 ...">`);
    html += field(`<label class="note">카드 비밀번호(4자리)</label><input id="pPin" class="input" inputmode="numeric" maxlength="4" placeholder="0000">`);
    html += `<div class="note" style="margin-top:8px">국내전용 카드번호는 9496…로 시작해.</div>`;
  } else if(c==='보험'){
    html += field(`<label class="note">보험 상품명</label><input id="pInsName" class="input" placeholder="예: 선우안심보험">`);
    html += field(`<label class="note">월 보험료(원)</label><input id="pInsPremium" class="input" type="number" min="0" placeholder="예: 15000">`);
  }
  prodFields.innerHTML = html;

  // wire dynamic toggles
  const netSel = document.getElementById('pNetwork');
  const foreignBox = document.getElementById('pForeignBox');
  if(netSel && foreignBox){
    const sync = ()=>{ foreignBox.classList.toggle('hidden', netSel.value!=='FOREIGN'); };
    netSel.onchange = sync; sync();
  }
  const agreeBtn = document.getElementById('pCreditAgree');
  if(agreeBtn){
    agreeBtn.onclick = ()=>{ window.__creditAgree = true; document.getElementById('pAgreeState').textContent='동의 완료'; };
    window.__creditAgree = false;
  }
}

if(prodCategory){
  prodCategory.onchange = setTypeOptions;
  prodType.onchange = renderFields;
  setTypeOptions();
}

if(prodApply){
  prodApply.onclick = async ()=>{
    try{
      prodMsg.textContent='';
      if(!selectedCustomer) throw new Error('고객 선택 필요');

      const c = prodCategory.value;
      const t = prodType.value;
      const firstAcc = (selectedDetail && selectedDetail.accounts && selectedDetail.accounts[0]) ? selectedDetail.accounts[0].account_no : null;

      let data = {};
      if(c==='예적금'){
        const amount = Number(document.getElementById('pAmount').value||0);
        const term = t==='주택청약' ? 9999 : Number(document.getElementById('pTerm').value||0);
        if(amount<=0) throw new Error('가입 금액 입력');
        if(t!=='주택청약' && term<=0) throw new Error('기간 입력');
        data = { amount, term, termUnit: (t==='주택청약'?'year':'month') };
      } else if(c==='대출'){
        const amount = Number(document.getElementById('pLoanAmount').value||0);
        if(amount<=0) throw new Error('대출 금액 입력');
        data = { amount, interestRate: 0.04 };
      } else if(c==='투자'){
        const fundName = (document.getElementById('pFundName').value||'').trim();
        const amount = Number(document.getElementById('pFundAmount').value||0);
        if(!fundName) throw new Error('펀드명 입력');
        if(amount<=0) throw new Error('투자금 입력');
        data = { fundName, amount };
      } else if(c==='카드'){
        const ship = (document.getElementById('pShip').value||'').trim();
        const pin = (document.getElementById('pPin').value||'').trim();
        if(pin.length!==4) throw new Error('비밀번호 4자리');
        const net = document.getElementById('pNetwork').value;
        let network = 'DOMESTIC';
        if(net==='FOREIGN'){
          network = document.getElementById('pBrand').value; // VISA/MASTER
        }
        if(!ship) throw new Error('배송지 입력');

        if(t==='신용카드'){
          const limit = Number(document.getElementById('pCreditLimit').value||0);
          if(limit<=0) throw new Error('신용카드 한도 입력');
          if(!window.__creditAgree) throw new Error('신용정보 동의 필요');
          data = { cardType:'신용카드', creditLimit: limit, creditAgree:true, network, shippingAddress: ship, pin };
        } else {
          data = { cardType:'체크카드', network, shippingAddress: ship, pin };
        }
      } else if(c==='보험'){
        const name = (document.getElementById('pInsName').value||'').trim();
        const premium = Number(document.getElementById('pInsPremium').value||0);
        if(!name) throw new Error('보험 상품명 입력');
        if(premium<=0) throw new Error('보험료 입력');
        data = { insuranceName:name, premium };
      }

      const res = await api('teller.product.apply', {
        customerId: selectedCustomer.id,
        accountNo: firstAcc,
        category: c,
        productType: t,
        data
      });

      if(res.card && res.card.card_number){
        prodMsg.textContent = `완료! 카드번호: ${res.card.card_number} (${res.card.network})`;
      } else {
        prodMsg.textContent = '완료! 신청이 저장됨.';
      }
    }catch(e){
      prodMsg.textContent = '실패: ' + (e.message || e);
    }
  };
}


document.getElementById('login').onclick = async ()=>{
  tellerCode = (document.getElementById('code').value||'').trim();
  localStorage.setItem('tellerCode', tellerCode);
  if(tellerCode !== '0612'){
    loggedIn = false;
    localStorage.setItem('tellerLoggedIn','0');
    loginMsg.textContent = '코드가 틀림. (0612)';
    setSessionUI();
    return;
  }
  loggedIn = true;
  localStorage.setItem('tellerLoggedIn','1');
  loginMsg.textContent = '로그인 완료';
  setSessionUI();
  await refreshSelected();
};

logoutBtn.onclick = ()=>{
  loggedIn = false;
  localStorage.setItem('tellerLoggedIn','0');
  setSessionUI();
};

document.getElementById('refresh').onclick = ()=> refreshSelected();

document.querySelectorAll('.nav button').forEach(b=>{
  b.onclick = ()=>{
    const t = b.dataset.tab;
    document.querySelectorAll('[id^="tab-"]').forEach(x=>x.classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
  };
});

function money(n){ return (Number(n)||0).toLocaleString('ko-KR') + '원'; }

function setSelectedCustomer(c){
  selectedCustomer = c;
  selInfo.textContent = c ? `${c.name} · ${c.customer_no} · ${c.phone||'-'} · ${c.email||'-'} · (생년월일:${c.rrn_birth6})` : '없음';
}

function renderDashboard(){
  const accRows = document.getElementById('accRows');
  accRows.innerHTML = '';
  if(!selectedDetail){
    document.getElementById('dashHint').textContent = '고객을 선택해줘.';
    document.getElementById('kCust').textContent = '-';
    document.getElementById('kAcc').textContent = '-';
    document.getElementById('kJs').textContent = '-';
    document.getElementById('kBal').textContent = '-';
    return;
  }
  document.getElementById('dashHint').textContent = '';
  const accounts = selectedDetail.accounts || [];
  let sum = 0;
  accounts.forEach(a=>{
    sum += Number(a.balance||0);
    const flags = a.flags || {};
    const lim = [];
    if(flags.limitAccount) lim.push('한도');
    if(flags.paymentStop) lim.push('지급정지');
    if(flags.seizure) lim.push('압류');
    if(flags.provisionalSeizure) lim.push('가압류');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><b>${a.account_no}</b></td><td>${a.type}</td><td>${a.status}</td><td>${lim.join(' · ')||'-'}</td><td>${money(a.balance)}</td>`;
    accRows.appendChild(tr);
  });
  document.getElementById('kCust').textContent = '1';
  document.getElementById('kAcc').textContent = accounts.length;
  document.getElementById('kJs').textContent = (selectedDetail.jesingo||[]).length;
  document.getElementById('kBal').textContent = money(sum);
}

function fillAccountSelects(){
  const accts = (selectedDetail && selectedDetail.accounts) ? selectedDetail.accounts : [];
  ['ioAcc','trFrom','jsAcc','rAcc'].forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML='';
    accts.forEach(a=>{
      const o = document.createElement('option');
      o.value = a.account_no;
      o.textContent = `${a.account_no} (${money(a.balance)})`;
      sel.appendChild(o);
    });
  });
  updateRestrictPreview();
}

function renderJeSingoList(){
  const jsRows = document.getElementById('jsRows');
  jsRows.innerHTML='';
  const list = (selectedDetail && selectedDetail.jesingo) ? selectedDetail.jesingo : [];
  list.forEach(js=>{
    const tr = document.createElement('tr');
    const content = js.category==='비밀번호변경' ? `비밀번호 변경 (${js.detail||''})`
      : js.category==='정보변경' ? `정보변경: ${js.field} → ${js.new_value}`
      : js.category==='분실신고' ? `분실: ${js.item}`
      : (js.detail||'');
    tr.innerHTML = `<td>${new Date(js.created_at).toLocaleString()}</td><td><b>${js.category}</b></td><td>${content}</td><td>${js.status}</td>
    <td><button class="btn" data-id="${js.id}">처리완료</button></td>`;
    jsRows.appendChild(tr);
  });
  jsRows.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      try{
        await api('jesingo.process', { id: btn.dataset.id, status: '처리완료' });
        await refreshSelected();
      }catch(e){ alert('실패: '+e.message); }
    };
  });
}

function updateRestrictPreview(){
  const preview = document.getElementById('rPreview');
  const accNo = (function(){ var _e=document.getElementById('rAcc'); return _e ? _e.value : ''; })();
  if(!selectedDetail || !accNo){ preview.textContent='-'; return; }
  const acc = (selectedDetail.accounts||[]).find(a=>a.account_no===accNo);
  if(!acc){ preview.textContent='-'; return; }
  const f = acc.flags||{};
  const list = [];
  list.push(f.limitAccount?'한도계좌:ON':'한도계좌:OFF');
  list.push(f.paymentStop?'지급정지:ON':'지급정지:OFF');
  list.push(f.seizure?'압류:ON':'압류:OFF');
  list.push(f.provisionalSeizure?'가압류:ON':'가압류:OFF');
  preview.textContent = list.join(' · ');
}
document.getElementById('rAcc').onchange = updateRestrictPreview;

async function refreshSelected(){
  if(!loggedIn){ renderDashboard(); return; }
  if(!selectedCustomer){ selectedDetail=null; renderDashboard(); fillAccountSelects(); renderJeSingoList(); return; }
  const j = await api('teller.getCustomerDetail', { customerId: selectedCustomer.id });
  selectedDetail = j;
  renderDashboard();
  fillAccountSelects();
  renderJeSingoList();
}

// Search
document.getElementById('sBtn').onclick = async ()=>{
  try{
    const name = document.getElementById('sName').value.trim();
    const phone = document.getElementById('sPhone').value.trim();
    const email = document.getElementById('sEmail').value.trim();
    const j = await api('teller.searchCustomers', { name, phone, email });
    const arr = j.customers || [];
    resBox.classList.toggle('hidden', arr.length===0);
    resBox.innerHTML='';
    arr.forEach(c=>{
      const b = document.createElement('button');
      b.textContent = `${c.name} · ${c.customer_no} · ${c.phone||'-'} · ${c.email||'-'} · 생년월일:${c.rrn_birth6}`;
      b.onclick = async ()=>{
        setSelectedCustomer(c);
        resBox.classList.add('hidden');
        await refreshSelected();
      };
      resBox.appendChild(b);
    });
  }catch(e){ alert('검색 실패: '+e.message); }
};

// Customer create
document.getElementById('cCreate').onclick = async ()=>{
  try{
    const j = await api('teller.createCustomer', {
      name: document.getElementById('cName').value.trim(),
      rrn: document.getElementById('cRRN').value.trim(),
      phone: document.getElementById('cPhone').value.trim(),
      email: document.getElementById('cEmail').value.trim(),
      address: document.getElementById('cAddr').value.trim()
    });
    document.getElementById('cMsg').textContent = `생성 완료: ${j.customer.customer_no}`;
  }catch(e){
    document.getElementById('cMsg').textContent = '실패: ' + e.message;
  }
};

// Account create
document.getElementById('aCreate').onclick = async ()=>{
  try{
    if(!selectedCustomer) throw new Error('고객 선택 필요');
    const j = await api('teller.createAccount', {
      customerId: selectedCustomer.id,
      type: document.getElementById('aType').value,
      initialBalance: Number(document.getElementById('aBal').value||0),
      accountNo: document.getElementById('aNo').value.trim(),
      accountPin: document.getElementById('aPin').value.trim()
    });
    document.getElementById('aMsg').textContent = '개설 완료: ' + j.account.account_no;
    await refreshSelected();
  }catch(e){
    document.getElementById('aMsg').textContent = '실패: ' + e.message;
  }
};

// Cash in/out
document.getElementById('ioBtn').onclick = async ()=>{
  try{
    const j = await api('teller.cashInOut', {
      accountNo: document.getElementById('ioAcc').value,
      kind: document.getElementById('ioKind').value,
      amount: Number(document.getElementById('ioAmt').value),
      memo: document.getElementById('ioMemo').value.trim()
    });
    document.getElementById('ioMsg').textContent = '완료 / 잔액 ' + money(j.balance);
    await refreshSelected();
  }catch(e){
    document.getElementById('ioMsg').textContent = '실패: ' + e.message;
  }
};

// Transfer
document.getElementById('trBtn').onclick = async ()=>{
  try{
    await api('teller.transfer', {
      fromAccountNo: document.getElementById('trFrom').value,
      toAccountNo: document.getElementById('trTo').value.trim(),
      amount: Number(document.getElementById('trAmt').value),
      memo: document.getElementById('trMemo').value.trim()
    });
    document.getElementById('trMsg').textContent = '이체 완료';
    await refreshSelected();
  }catch(e){
    document.getElementById('trMsg').textContent = '실패: ' + e.message;
  }
};

// JeSingo category UI
const jsCat = document.getElementById('jsCat');
const jsPwBox = document.getElementById('jsPwBox');
const jsInfoBox = document.getElementById('jsInfoBox');
const jsLostBox = document.getElementById('jsLostBox');
function jsRender(){
  const v = jsCat.value;
  jsPwBox.classList.toggle('hidden', v !== '비밀번호변경');
  jsInfoBox.classList.toggle('hidden', v !== '정보변경');
  jsLostBox.classList.toggle('hidden', v !== '분실신고');
}
jsCat.onchange = jsRender; jsRender();

document.getElementById('jsBtn').onclick = async ()=>{
  try{
    if(!selectedCustomer) throw new Error('고객 선택 필요');
    const category = jsCat.value;
    const detail = document.getElementById('jsDetail').value.trim();
    const payload = { customerId: selectedCustomer.id, category, detail };

    if(category === '비밀번호변경'){
      const accNo = document.getElementById('jsAcc').value;
      const oldPin = document.getElementById('jsOldPin').value.trim();
      const np1 = document.getElementById('jsNewPin').value.trim();
      const np2 = document.getElementById('jsNewPin2').value.trim();
      if(np1 !== np2) throw new Error('새 비밀번호 확인 불일치');
      payload.accountNo = accNo;
      payload.accountPinOld = oldPin;
      payload.accountPinNew = np1;
    }
    if(category === '정보변경'){
      payload.field = document.getElementById('jsField').value;
      payload.newValue = document.getElementById('jsNewVal').value.trim();
    }
    if(category === '분실신고'){
      payload.item = document.getElementById('jsItem').value;
    }

    await api('jesingo.create', payload);
    document.getElementById('jsMsg').textContent = '접수 완료';
    await refreshSelected();
  }catch(e){
    document.getElementById('jsMsg').textContent = '실패: ' + e.message;
  }
};

// Restrict apply
document.getElementById('rApply').onclick = async ()=>{
  try{
    const accNo = document.getElementById('rAcc').value;
    const paymentStop = document.getElementById('rPay').value === 'on';
    const limitAccount = document.getElementById('rLimit').value === 'on';
    const seizure = document.getElementById('rSeiz').value === 'on';
    const provisionalSeizure = document.getElementById('rProv').value === 'on';
    const holdAmount = Number(document.getElementById('rHold').value||0);
    await api('restrict.set', { accountNo: accNo, paymentStop, limitAccount, seizure, provisionalSeizure, holdAmount });
    document.getElementById('rMsg').textContent = '적용 완료';
    await refreshSelected();
  }catch(e){
    document.getElementById('rMsg').textContent = '실패: ' + e.message;
  }
};
document.getElementById('rReleaseLimit').onclick = async ()=>{
  try{
    const accNo = document.getElementById('rAcc').value;
    await api('restrict.releaseLimit', { accountNo: accNo });
    document.getElementById('rMsg').textContent = '한도계좌 해제 완료';
    await refreshSelected();
  }catch(e){
    document.getElementById('rMsg').textContent = '실패: ' + e.message;
  }
};

// Enroll internet banking
document.getElementById('eBtn').onclick = async ()=>{
  try{
    const j = await api('admin.enrollInternetBanking', {
      name: document.getElementById('eName').value.trim(),
      email: document.getElementById('eEmail').value.trim(),
      tempPassword: document.getElementById('ePw').value,
      phone: document.getElementById('ePhone').value.trim()
    });
    document.getElementById('eMsg').textContent = '완료: 고객번호 ' + j.customer_no;
  }catch(e){
    document.getElementById('eMsg').textContent = '실패: ' + e.message;
  }
};

}

// ---------- 상품가입 ----------
function renderProducts(){
  const box = document.getElementById('prodBox');
  const msg = document.getElementById('prodMsg');
  if(!box) return;
  msg.textContent = '';
  const cust = selectedCustomer;
  if(!cust){
    box.innerHTML = '<div class="note">먼저 고객을 검색/선택해줘.</div>';
    return;
  }
  const accList = (selectedDetail && selectedDetail.accounts) ? selectedDetail.accounts : [];
  const accNo = accList[0] ? accList[0].account_no : '';

  box.innerHTML = `
  <div class="grid2">
    <div class="card2">
      <div style="font-weight:900;margin-bottom:8px">카테고리</div>
      <select id="pCat" class="input">
        <option>예적금</option>
        <option>대출</option>
        <option>투자</option>
        <option>카드</option>
        <option>보험</option>
      </select>
      <div style="height:10px"></div>
      <div class="note">선택 고객: <b>${escapeHtml(cust.name)}</b> · 계좌(기본): ${escapeHtml(accNo||'-')}</div>
    </div>

    <div class="card2">
      <div style="font-weight:900;margin-bottom:8px">가입 정보</div>
      <div id="pFields"></div>
      <div style="height:10px"></div>
      <button id="pApply" class="btn ok" style="width:100%">가입 처리</button>
      <div class="note" style="margin-top:10px">※ 데모 규칙: 대출 이자 4% 고정, 주택청약 만기 9999년</div>
    </div>
  </div>
  `;

  const fields = document.getElementById('pFields');
  const cat = document.getElementById('pCat');

  function renderFields(){
    const c = cat.value;
    if(c === '예적금'){
      fields.innerHTML = `
        <label class="note">상품</label>
        <select id="pType" class="input">
          <option>정기적금</option>
          <option>자유적금</option>
          <option>주택청약</option>
        </select>
        <div style="height:10px"></div>
        <label class="note">가입 금액</label>
        <input id="pAmt" class="input" type="number" min="0" value="10000"/>
        <div style="height:10px"></div>
        <label class="note">기간(년)</label>
        <input id="pTerm" class="input" type="number" min="1" value="1"/>
        <div class="note" id="pHint" style="margin-top:8px"></div>
      `;
      const pType = document.getElementById('pType');
      const term = document.getElementById('pTerm');
      const hint = document.getElementById('pHint');
      const sync = ()=>{
        if(pType.value==='주택청약'){
          term.value = 9999;
          term.disabled = true;
          hint.textContent = '주택청약은 만기 9999년으로 고정됨';
        } else {
          term.disabled = false;
          hint.textContent = '';
        }
      };
      pType.onchange = sync; sync();
    } else if(c === '대출'){
      fields.innerHTML = `
        <label class="note">빌릴 금액</label>
        <input id="pLoan" class="input" type="number" min="0" value="1000000"/>
        <div style="height:10px"></div>
        <div class="badge">이자: 4% 고정</div>
      `;
    } else if(c === '투자'){
      fields.innerHTML = `
        <label class="note">펀드 상품명</label>
        <input id="pFund" class="input" value="선우 밸런스 펀드"/>
        <div style="height:10px"></div>
        <label class="note">투자금</label>
        <input id="pInv" class="input" type="number" min="0" value="50000"/>
      `;
    } else if(c === '카드'){
      fields.innerHTML = `
        <label class="note">카드 종류</label>
        <select id="pCardType" class="input">
          <option>체크카드</option>
          <option>신용카드</option>
        </select>
        <div style="height:10px"></div>

        <div id="creditBox" class="hidden">
          <label class="note">신용 한도</label>
          <input id="pLimit" class="input" type="number" min="0" value="1000000"/>
          <div style="height:10px"></div>
          <button id="pAgree" class="btn2" style="width:100%">신용정보 동의</button>
          <div class="note" id="pAgreeMsg" style="margin-top:8px">동의해야 발급 가능</div>
          <div style="height:10px"></div>
        </div>

        <label class="note">국내/해외</label>
        <select id="pDomestic" class="input">
          <option value="DOMESTIC">국내전용</option>
          <option value="GLOBAL">해외겸용</option>
        </select>
        <div style="height:10px"></div>

        <div id="netBox" class="hidden">
          <label class="note">브랜드</label>
          <select id="pNetwork" class="input">
            <option value="VISA">VISA</option>
            <option value="MASTER">MASTER</option>
          </select>
        </div>
        <div style="height:10px"></div>

        <label class="note">배송지</label>
        <input id="pShip" class="input" placeholder="예: 부산 ..."/>
        <div style="height:10px"></div>
        <label class="note">카드 비밀번호(4자리)</label>
        <input id="pPin" class="input" inputmode="numeric" maxlength="4" placeholder="예: 1234"/>
        <div class="note" style="margin-top:8px">번호 규칙: 국내 9496, VISA 4816, MASTER 5927</div>
      `;

      const cardType = document.getElementById('pCardType');
      const creditBox = document.getElementById('creditBox');
      const agreeBtn = document.getElementById('pAgree');
      const agreeMsg = document.getElementById('pAgreeMsg');
      const domestic = document.getElementById('pDomestic');
      const netBox = document.getElementById('netBox');

      let agreed = false;
      const sync = ()=>{
        const isCredit = cardType.value==='신용카드';
        creditBox.classList.toggle('hidden', !isCredit);
        if(!isCredit){ agreed = true; agreeMsg.textContent='(체크카드는 동의 불필요)'; }
        else { agreed = false; agreeMsg.textContent='동의해야 발급 가능'; }
        netBox.classList.toggle('hidden', domestic.value!=='GLOBAL');
      };

      agreeBtn.onclick = ()=>{ agreed=true; agreeMsg.textContent='동의 완료'; };
      cardType.onchange = sync;
      domestic.onchange = sync;
      sync();

      // store agreed state on element for apply
      creditBox.dataset.agreedRef = '1';
      fields.dataset.getAgreed = ()=>agreed;
      fields.__getAgreed = ()=>agreed;
    } else { // 보험
      fields.innerHTML = `
        <label class="note">보험 상품명</label>
        <input id="pIns" class="input" value="미니 상해보험"/>
        <div style="height:10px"></div>
        <label class="note">월 납입액</label>
        <input id="pInsAmt" class="input" type="number" min="0" value="9900"/>
      `;
    }
  }

  cat.onchange = renderFields;
  renderFields();

  document.getElementById('pApply').onclick = async ()=>{
    try{
      const c = document.getElementById('pCat').value;
      let productType = '';
      let data = {};
      if(c==='예적금'){
        productType = document.getElementById('pType').value;
        data.amount = Number(document.getElementById('pAmt').value||0);
        data.termYears = Number(document.getElementById('pTerm').value||0);
      } else if(c==='대출'){
        productType = '대출';
        data.amount = Number(document.getElementById('pLoan').value||0);
        data.interestRate = 0.04;
      } else if(c==='투자'){
        productType = '펀드';
        data.fundName = document.getElementById('pFund').value.trim();
        data.amount = Number(document.getElementById('pInv').value||0);
      } else if(c==='카드'){
        const ct = document.getElementById('pCardType').value;
        productType = ct;
        const domestic = document.getElementById('pDomestic').value;
        const network = domestic==='GLOBAL' ? document.getElementById('pNetwork').value : 'DOMESTIC';
        const pin = (document.getElementById('pPin').value||'').trim();
        const ship = document.getElementById('pShip').value.trim();
        if(pin.length<4) throw new Error('비밀번호 4자리 필요');

        // credit validation
        if(ct==='신용카드'){
          // read agreed from closure
          const agreed = fields.__getAgreed ? fields.__getAgreed() : false;
          if(!agreed) throw new Error('신용정보 동의 필요');
          data.creditLimit = Number(document.getElementById('pLimit').value||0);
        }
        data.cardType = ct;
        data.network = network;
        data.shippingAddress = ship;
        data.pin = pin;
      } else { // 보험
        productType = '보험';
        data.productName = document.getElementById('pIns').value.trim();
        data.monthly = Number(document.getElementById('pInsAmt').value||0);
      }

      const res = await api('teller.product.apply', {
        customerId: cust.id,
        accountNo: accNo || null,
        category: c,
        productType,
        data
      });

      if(res.card && res.card.card_number){
        msg.textContent = `가입 완료 · 발급 카드번호: ${res.card.card_number} (${res.card.network})`;
      } else {
        msg.textContent = '가입 완료';
      }
    }catch(e){
      msg.textContent = '실패: ' + (e.message||e);
    }
  };
}


/* ===== 작성된 서식 보기 (실시간 폴링) ===== */
const openFormsBtn = document.getElementById('openForms');
const formsPanel = document.getElementById('formsPanel');
const formsRefresh = document.getElementById('formsRefresh');
const formsList = document.getElementById('formsList');
const formModal = document.getElementById('formModal');
const fmClose = document.getElementById('fmClose');
const fmTitle = document.getElementById('fmTitle');
const fmJson = document.getElementById('fmJson');
const fmSig = document.getElementById('fmSig');

let formsPollTimer = null;
let lastFormsHash = '';

function hashForms(arr){
  try{
    return (arr||[]).map(x=>x.id+":"+x.created_at).join("|");
  }catch(e){ return String(Date.now()); }
}

function fmtDate(s){
  try{ return new Date(s).toLocaleString(); }catch(e){ return s || "-"; }
}

function renderForms(forms){
  if(!formsList) return;
  if(!forms || forms.length===0){
    formsList.innerHTML = '<div class="note">아직 제출된 서식이 없어요.</div>';
    return;
  }
  formsList.innerHTML = forms.map(f=>{
    const fd = f.form_data || {};
    const title = (fd.requestType || f.form_type || '서식');
    const who = (fd.applicantType === 'agent')
      ? (fd.agentText ? fd.agentText : '대리인')
      : (fd.selfName ? fd.selfName : '본인');
    const dt = fmtDate(f.created_at);
    return `<div class="formRow" data-formid="${f.id}">
      <div>
        <div style="font-weight:700">${title}</div>
        <div class="note" style="margin-top:4px">${who} · ${f.status || 'submitted'}</div>
      </div>
      <div class="note" style="text-align:right;min-width:180px">${dt}</div>
    </div>`;
  }).join('');

  // click handlers
  [...formsList.querySelectorAll('.formRow')].forEach(row=>{
    row.addEventListener('click', async ()=>{
      const formId = row.getAttribute('data-formid');
      await openFormModal(formId);
    });
  });
}

async function loadForms(force=false){
  if(!formsPanel || formsPanel.classList.contains('hidden')) return;
  if(!selectedCustomer){
    if(force) alert('고객을 먼저 선택해줘.');
    return;
  }
  try{
    const j = await api('teller.forms.list', { customerId: selectedCustomer.id, limit: 30 });
    const forms = j.forms || [];
    const h = hashForms(forms);
    if(force || h !== lastFormsHash){
      lastFormsHash = h;
      renderForms(forms);
    }
  }catch(e){
    if(force) alert('서식 조회 실패: ' + (e.message || e));
  }
}

async function openFormModal(formId){
  if(!formId) return;
  try{
    const j = await api('teller.forms.get', { formId });
    const f = j.form;
    const fd = f.form_data || {};
    const title = (fd.requestType || f.form_type || '서식');
    if(fmTitle) fmTitle.textContent = title + " · " + fmtDate(f.created_at);
    if(fmJson) fmJson.textContent = JSON.stringify(fd, null, 2);
    if(fmSig) fmSig.src = (f.signature_image || '');
    if(formModal) formModal.classList.remove('hidden');
  }catch(e){
    alert('서식 불러오기 실패: ' + (e.message || e));
  }
}

function startFormsPoll(){
  stopFormsPoll();
  formsPollTimer = setInterval(()=>loadForms(false), 3000);
}
function stopFormsPoll(){
  if(formsPollTimer) clearInterval(formsPollTimer);
  formsPollTimer = null;
}

if(openFormsBtn){
  openFormsBtn.addEventListener('click', async ()=>{
    if(!formsPanel) return;
    formsPanel.classList.toggle('hidden');
    if(!formsPanel.classList.contains('hidden')){
      await loadForms(true);
      startFormsPoll();
    }else{
      stopFormsPoll();
    }
  });
}
if(formsRefresh){
  formsRefresh.addEventListener('click', ()=>loadForms(true));
}
if(fmClose){
  fmClose.addEventListener('click', ()=>{ if(formModal) formModal.classList.add('hidden'); });
}
if(formModal){
  formModal.addEventListener('click', (e)=>{ if(e.target === formModal) formModal.classList.add('hidden'); });
}

// 고객 선택이 바뀌면(선택 고객 갱신) 서식 패널이 열려있을 때 자동 새로고침
const _origSetSelectedCustomer = setSelectedCustomer;
setSelectedCustomer = function(c){
  _origSetSelectedCustomer(c);
  loadForms(true);
};
</script>
<div id="formModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modalBox">
    <div class="row" style="justify-content:space-between;gap:10px">
      <div>
        <div class="note">작성된 서식</div>
        <div id="fmTitle" style="font-weight:700;margin-top:4px">-</div>
      </div>
      <button id="fmClose" class="btn">닫기</button>
    </div>
    <div style="height:10px"></div>
    <div class="pre" id="fmJson"></div>
    <div style="height:10px"></div>
    <div class="note">서명</div>
    <img id="fmSig" class="sigImg" alt="signature" />
  </div>
</div>

</body>
</html>
