<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>선우뱅크 · 고객</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
:root{--bg:#f5f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--btn:#111827;--btnText:#fff}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:rgba(245,247,251,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,#60a5fa,#34d399)}
h1{font-size:18px;margin:0}
.small{font-size:12px;color:var(--muted)}
.btn{border:0;background:var(--btn);color:var(--btnText);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn2{border:1px solid var(--line);background:#fff;color:#111827;padding:10px 12px;border-radius:12px;cursor:pointer}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
.card h2{font-size:14px;margin:0 0 8px 0}
.hr{height:1px;background:var(--line);margin:10px 0}
.input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{font-size:12px;padding:8px 6px;border-bottom:1px solid var(--line);text-align:left}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#111827}
.hidden{display:none}
.note{font-size:12px;color:var(--muted)}
/* Hide Sign Up in widget as much as possible */
.netlify-identity-widget .btn.signup, .netlify-identity-widget .signup{display:none!important;}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>선우뱅크 · 고객</h1>
          <div class="small">Netlify Identity 로그인 · 데모 (실제 금융 서비스 아님)</div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <span id="who" class="badge">로그인 필요</span>
        <button id="loginBtn" class="btn">로그인</button>
        <button id="logoutBtn" class="btn2 hidden">로그아웃</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="loggedOut" class="card">
    <h2>안내</h2>
    <div class="note">Invite-only라서 고객은 직접 회원가입이 아니라, 텔러(창구)에서 인터넷뱅킹 가입을 처리해야 로그인할 수 있어요.</div>
  </div>

  <div id="app" class="hidden">
    <div class="grid">
      <div class="card">
        <h2>내 계좌</h2>
        <div class="note" id="custId"></div>
        <div class="hr"></div>
        <div id="acctList"></div>
      </div>

      <div class="card">
        <h2>이체</h2>
        <div class="note">지급정지/계좌정지 상태면 이체가 제한될 수 있어요.</div>
        <div class="hr"></div>

        <label class="note">출금계좌</label>
        <select id="fromSel"></select>
        <div style="height:8px"></div>

        <label class="note">받는계좌번호</label>
        <input id="toNo" class="input" placeholder="예: 110-1234-5678"/>
        <div style="height:8px"></div>

        <label class="note">금액</label>
        <input id="amt" class="input" type="number" placeholder="예: 10000"/>
        <div style="height:8px"></div>

        <label class="note">메모(선택)</label>
        <input id="memo" class="input" placeholder="예: 점심값"/>
        <div style="height:12px"></div>

        <button id="sendBtn" class="btn" style="width:100%">이체하기</button>
        <div id="msg" class="note" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>최근 거래</h2>
      <div class="note">최대 30건 표시</div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>시간</th><th>유형</th><th>금액</th><th>메모</th></tr></thead>
          <tbody id="txRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const who = document.getElementById('who');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const app = document.getElementById('app');
const loggedOut = document.getElementById('loggedOut');
const custId = document.getElementById('custId');
const acctList = document.getElementById('acctList');
const fromSel = document.getElementById('fromSel');
const txRows = document.getElementById('txRows');
const msg = document.getElementById('msg');

function money(n){ return (Number(n)||0).toLocaleString('ko-KR') + '원'; }

function showLoggedIn(user){
  who.textContent = user.email;
  logoutBtn.classList.remove('hidden');
  app.classList.remove('hidden');
  loggedOut.classList.add('hidden');
}

function showLoggedOut(){
  who.textContent = '로그인 필요';
  logoutBtn.classList.add('hidden');
  app.classList.add('hidden');
  loggedOut.classList.remove('hidden');
}

async function api(action, payload){
  const u = netlifyIdentity.currentUser();
  if(!u) throw new Error('로그인 필요');
  const jwt = await u.jwt();
  const r = await fetch('/.netlify/functions/bank', {
    method:'POST',
    headers:{
      'content-type':'application/json',
      'authorization':'Bearer ' + jwt
    },
    body: JSON.stringify({action, payload})
  });
  const t = await r.text();
  let j; try{ j = JSON.parse(t);}catch{ j = {ok:false, raw:t};}
  if(!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));
  return j;
}

function renderAccounts(accounts){
  acctList.innerHTML='';
  fromSel.innerHTML='';
  accounts.forEach(a=>{
    const div = document.createElement('div');
    div.className='card';
    div.style.margin='10px 0';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-weight:700">${a.accountNo}</div>
          <div class="note">${a.type} · 상태: ${a.status} ${a.flags?.paymentStop?'· 지급정지':''} ${a.flags?.seizure?'· 압류':''} ${a.flags?.provisionalSeizure?'· 가압류':''}</div>
        </div>
        <div style="font-weight:800">${money(a.balance)}</div>
      </div>`;
    acctList.appendChild(div);

    const opt = document.createElement('option');
    opt.value = a.accountNo;
    opt.textContent = `${a.accountNo} (${money(a.balance)})`;
    fromSel.appendChild(opt);
  });
}

function renderTx(txs){
  txRows.innerHTML='';
  txs.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(tx.at).toLocaleString()}</td><td>${tx.kind}</td><td>${money(tx.amount)}</td><td>${tx.memo||''}</td>`;
    txRows.appendChild(tr);
  });
}

async function bootstrap(){
  msg.textContent='';
  try{
    const j = await api('customer.bootstrap', {});
    custId.textContent = '고객번호: ' + j.customerId;
    renderAccounts(j.accounts || []);
    renderTx(j.txs || []);
  }catch(e){
    msg.textContent = '오류: ' + e.message;
  }
}

loginBtn.onclick = ()=> netlifyIdentity.open('login');
logoutBtn.onclick = ()=> netlifyIdentity.logout();

netlifyIdentity.on('init', user=>{
  if(user){ showLoggedIn(user); bootstrap(); } else { showLoggedOut(); }
});
netlifyIdentity.on('login', user=>{
  netlifyIdentity.close();
  showLoggedIn(user);
  bootstrap();
});
netlifyIdentity.on('logout', ()=>{
  showLoggedOut();
});

document.getElementById('sendBtn').onclick = async ()=>{
  const fromAccountNo = fromSel.value;
  const toAccountNo = document.getElementById('toNo').value.trim();
  const amount = Number(document.getElementById('amt').value);
  const memo = document.getElementById('memo').value.trim();
  msg.textContent='';
  try{
    const j = await api('customer.transfer', {fromAccountNo,toAccountNo,amount,memo});
    msg.textContent = '이체 완료: ' + j.tx.id;
    await bootstrap();
  }catch(e){
    msg.textContent = '이체 실패: ' + e.message;
  }
};
</script>
</body>
</html>
